var Editor=function(){this.landmarks=document.querySelectorAll(".guide-landmark");this.output=[];this.init=function(){var image,label,textarea;for(var a=0,b=this.landmarks.length;a<b;a+=1){image=this.landmarks[a].querySelector("img");label=this.landmarks[a].querySelector(".guide-text");label.style.flex="1 1 auto";textarea=document.createElement("textarea");textarea.style.width="90%";textarea.style.height="96px";textarea.style.verticalAlign="middle";textarea.value=label.innerHTML.split("<button")[0].trim();textarea.addEventListener("change",this.update.bind(this,textarea,image,a));label.replaceChild(textarea,label.firstChild);this.output[a]={type:"waypoint",photo:image.src.split("/").pop(),description:textarea.value}}};this.save=function(){console.log(JSON.stringify(this.output,null,"\t"))};this.update=function(input,image,index,evt){this.output[index].description=input.value};this.init()};var Filters=function(config){this.element=null;this.promise=null;this.searchInput=null;this.sortSelect=null;this.filterSelect=null;this.delay=null;this.init=function(config){this.element=config.element;this.promise=config.promise||function(){};this.searchInput=this.element.getElementsByTagName("input")[0];this.searchInput.addEventListener("blur",this.onSearchChanged.bind(this));this.searchInput.addEventListener("keyup",this.onSearchChanged.bind(this));this.searchInput.addEventListener("change",this.onSearchChanged.bind(this));this.sortSelect=this.element.getElementsByTagName("select")[0];this.sorters=this.sortSelect.getElementsByTagName("option");this.sortSelect.addEventListener("change",this.onSorterSelected.bind(this));this.filterSelect=this.element.getElementsByTagName("select")[1];this.filters=this.filterSelect.getElementsByTagName("option");this.filterSelect.addEventListener("change",this.onFilterSelected.bind(this));this.element.addEventListener("submit",this.onSearchSubmit.bind(this));if(!/MSIE/i.test(navigator.userAgent)){this.searchInput.addEventListener("click",this.onSearchReset.bind(this))}else{this.searchInput.style.backgroundImage="none"}return this};this.redrawSort=function(index){this.sortSelect.selectedIndex=index};this.redrawFilter=function(index){this.filterSelect.selectedIndex=index};this.searchFor=function(keyword){var a,b,contents,className,sortees=document.querySelectorAll(this.element.getAttribute("data-target")),findTags=new RegExp("<[^>]*>","g"),findKeyword=new RegExp(keyword,"i");for(a=0,b=sortees.length;a<b;a+=1){contents=sortees[a].innerHTML.replace(findTags," ");className=sortees[a].className.replace(/ no-match/g,"");sortees[a].className=findKeyword.test(contents)?className:className+" no-match"}this.promise("search complete")};this.sortBy=function(index){var a,b,unsorted=[],sorted=[],source=this.sorters[index].getAttribute("data-source"),method=this.sorters[index].getAttribute("data-type"),sortees=document.querySelectorAll(this.element.getAttribute("data-target")),parent=sortees[0].parentNode,fragment=document.createDocumentFragment();for(a=0,b=sortees.length;a<b;a+=1){unsorted.push(sortees[a])}sorted=unsorted.sort(function(a,b){a=a.querySelector(source).innerHTML;b=b.querySelector(source).innerHTML;if(method==="number"){a=parseFloat(a);b=parseFloat(b)}return a<b?-1:1});for(a=0,b=sorted.length;a<b;a+=1){fragment.appendChild(parent.removeChild(sorted[a],true))}parent.appendChild(fragment);this.redrawSort(index);this.promise("sort complete")};this.filterBy=function(index){var a,b,element,className,source=this.filters[index].getAttribute("data-source"),condition=new RegExp(this.filters[index].getAttribute("data-filter"),"i"),filtrates=document.querySelectorAll(this.element.getAttribute("data-target"));for(a=0,b=filtrates.length;a<b;a+=1){element=filtrates[a].querySelector(source);className=filtrates[a].className.replace(/ filtered-out/g,"");filtrates[a].className=element&&condition.test(element.innerHTML)?className:className+" filtered-out"}this.redrawFilter(index);this.promise("filter complete")};this.onSearchSubmit=function(evt){evt.preventDefault();this.searchFor(this.searchInput.value.trim());this.searchInput.blur()};this.onSearchReset=function(evt){if(this.searchInput.offsetWidth-evt.layerX<32){evt.preventDefault();this.searchInput.blur();this.searchInput.value="";this.searchFor("")}};this.onSearchChanged=function(evt){var _this=this;clearTimeout(this.delay);this.delay=setTimeout(function(){_this.searchFor(_this.searchInput.value.trim())},700)};this.onSorterSelected=function(evt){evt.preventDefault();this.sortBy(this.sortSelect.selectedIndex)};this.onFilterSelected=function(evt){evt.preventDefault();this.filterBy(this.filterSelect.selectedIndex)};this.init(config)};if(typeof define!="undefined")define([],function(){return Filters});if(typeof module!="undefined")module.exports=Filters;var Localmap=function(config){this.config={key:null,alias:null,container:null,legend:null,canvasWrapper:null,canvasElement:null,thumbsUrl:null,photosUrl:null,markersUrl:null,guideUrl:null,routeUrl:null,mapUrl:null,tilesUrl:null,tilesZoom:15,exifUrl:null,guideData:null,routeData:null,exifData:null,creditsTemplate:null,useTransitions:null,minimum:{lon:null,lat:null,lon_cover:null,lat_cover:null,zoom:null},maximum:{lon:null,lat:null,lon_cover:null,lat_cover:null,zoom:null},position:{lon:null,lat:null,zoom:null},indicator:{icon:null,photo:null,description:null,lon:null,lat:null,zoom:null,referrer:null},hotspots:[],checkHotspot:function(){return true},enterHotspot:function(){return true},leaveHotspot:function(){return true},distortX:function(x){return x},distortY:function(y){return y},supportColour:function(id){return"darkorange"}};for(var key in config)this.config[key]=config[key];this.update=function(){clearTimeout(this.saveTimeout);this.saveTimeout=window.setTimeout(this.store.bind(this),1e3);window.cancelAnimationFrame(this.animationFrame);this.animationFrame=window.requestAnimationFrame(this.redraw.bind(this))};this.redraw=function(){for(var key in this.components)if(this.components[key].update)this.components[key].update(this.config)};this.focus=function(lon,lat,zoom,smoothly){this.config.useTransitions=smoothly;this.config.position.lon=Math.max(Math.min(lon,this.config.maximum.lon_cover),this.config.minimum.lon_cover);this.config.position.lat=Math.min(Math.max(lat,this.config.maximum.lat_cover),this.config.minimum.lat_cover);this.config.position.zoom=Math.max(Math.min(zoom,this.config.maximum.zoom),this.config.minimum.zoom);this.update()};this.store=function(){var state={};state[this.config.key]={lon:this.config.position.lon,lat:this.config.position.lat,zoom:this.config.position.zoom};localStorage.setItem("localmap",JSON.stringify(state))};this.restore=function(lon,lat,zoom){var state=JSON.parse(localStorage.getItem("localmap"));var key=this.config.key;if(state&&state[key]){this.focus(state[key].lon,state[key].lat,state[key].zoom,false)}else{this.focus(lon,lat,zoom,false)}};this.describe=function(markerdata){this.components.modal.show(markerdata);if(markerdata.callback)markerdata.callback(markerdata)};this.stop=function(){for(var key in this.components)if(this.components[key].stop)this.components[key].stop(this.config)};this.indicate=function(input){var canvas=this.components.canvas;var indicator=canvas.components.indicator;indicator.reset();indicator.show(input);return false};this.unindicate=function(){var canvas=this.components.canvas;var indicator=canvas.components.indicator;indicator.hide();return false};this.onComplete=function(){this.config.container.className=this.config.container.className.replace(/ localmap-busy/g,"");var max=this.config.maximum;var min=this.config.minimum;this.restore((max.lon_cover-min.lon_cover)/2+min.lon_cover,(max.lat_cover-min.lat_cover)/2+min.lat_cover,min.zoom*1.25)};this.config.container.className+=" localmap-busy";this.components={canvas:new this.Canvas(this,this.onComplete.bind(this),this.describe.bind(this),this.focus.bind(this)),controls:new this.Controls(this),scale:new this.Scale(this),credits:new this.Credits(this),modal:new this.Modal(this),legend:new this.Legend(this,this.indicate.bind(this))}};if(typeof define!="undefined")define([],function(){return Localmap});if(typeof module!="undefined")module.exports=Localmap;Localmap.prototype.Background=function(parent,onComplete){this.parent=parent;this.config=parent.config;this.element=null;this.image=new Image;this.tilesQueue=null;this.tilesSize=256;var long2tile=function long2tile(lon,zoom){return Math.floor((lon+180)/360*Math.pow(2,zoom))};var lat2tile=function lat2tile(lat,zoom){return Math.floor((1-Math.log(Math.tan(lat*Math.PI/180)+1/Math.cos(lat*Math.PI/180))/Math.PI)/2*Math.pow(2,zoom))};var tile2long=function tile2long(x,z){return x/Math.pow(2,z)*360-180};var tile2lat=function tile2lat(y,z){var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))};this.start=function(){this.element=document.createElement("div");this.element.setAttribute("class","localmap-background");this.parent.element.appendChild(this.element);this.parent.canvasElement=this.element;if(this.config.tilesUrl){this.loadTiles()}else{this.loadBitmap()}window.addEventListener("resize",this.redraw.bind(this))};this.stop=function(){this.parent.element.removeChild(this.element)};this.update=function(){};this.redraw=function(){var container=this.config.container;var element=this.element;var min=this.config.minimum;var max=this.config.maximum;min.zoom=Math.max(container.offsetWidth/element.offsetWidth,container.offsetHeight/element.offsetHeight);max.zoom=3};this.loadBitmap=function(){var key=this.config.alias||this.config.key;this.image.addEventListener("load",this.onBitmapLoaded.bind(this));this.image.setAttribute("src",this.config.mapUrl.replace("{key}",key))};this.drawBitmap=function(){var container=this.config.container;var element=this.element;var image=this.image;var min=this.config.minimum;var max=this.config.maximum;var pixelsPerLon=image.naturalWidth/(max.lon-min.lon);var pixelsPerLat=image.naturalHeight/(max.lat-min.lat);var offsetWidth=(min.lon-min.lon_cover)*pixelsPerLon;var offsetHeight=(min.lat-min.lat_cover)*pixelsPerLat;var croppedWidth=(max.lon_cover-min.lon_cover)*pixelsPerLon;var croppedHeight=(max.lat_cover-min.lat_cover)*pixelsPerLat;var displayWidth=croppedWidth/2;var displayHeight=croppedHeight/2;element.style.width=croppedWidth+"px";element.style.height=croppedHeight+"px";image.style.marginLeft=offsetWidth+"px";image.style.marginTop=offsetHeight+"px";element.appendChild(image);this.redraw();onComplete()};this.measureTiles=function(){var min=this.config.minimum;var max=this.config.maximum;var pos=this.config.position;var minX=long2tile(min.lon_cover,this.config.tilesZoom);var minY=lat2tile(min.lat_cover,this.config.tilesZoom);var maxX=long2tile(max.lon_cover,this.config.tilesZoom);var maxY=lat2tile(max.lat_cover,this.config.tilesZoom);var state=JSON.parse(localStorage.getItem("localmap"));var key=this.config.key;if(state&&state[key]){pos.lon=state[key].lon;pos.lat=state[key].lat}var posX=long2tile(pos.lon,this.config.tilesZoom);var posY=lat2tile(pos.lat,this.config.tilesZoom);return{minX:minX,minY:minY,maxX:maxX,maxY:maxY,posX:posX,posY:posY}};this.scoreMarkers=function(){var markers=this.config.guideData[this.config.key].markers;var lookup={};var x,y,t,r,b,l;for(var idx=0,max=markers.length;idx<max;idx+=1){x=long2tile(markers[idx].lon,this.config.tilesZoom);y=lat2tile(markers[idx].lat,this.config.tilesZoom);t=y-1;r=x+1;b=t+1;l=x-1;lookup[l+"_"+t]=-10;lookup[x+"_"+t]=-10;lookup[r+"_"+t]=-10;lookup[l+"_"+y]=-10;lookup[x+"_"+y]=-20;lookup[r+"_"+y]=-10;lookup[l+"_"+b]=-10;lookup[x+"_"+b]=-10;lookup[r+"_"+b]=-10}return lookup};this.loadTiles=function(){var container=this.config.container;var element=this.element;var coords=this.measureTiles();var gridWidth=Math.max(coords.maxX-coords.minX,1);var gridHeight=Math.max(coords.maxY-coords.minY,1);var tileSize=this.tilesSize;var croppedWidth=gridWidth*tileSize;var croppedHeight=gridHeight*tileSize;var displayWidth=croppedWidth/2;var displayHeight=croppedHeight/2;element.width=croppedWidth;element.height=croppedHeight;element.style.width=displayWidth+"px";element.style.height=displayHeight+"px";this.tilesQueue=[];var scoreLookup=this.scoreMarkers();for(var x=coords.minX;x<=coords.maxX;x+=1){for(var y=coords.minY;y<=coords.maxY;y+=1){this.tilesQueue.push({url:this.config.tilesUrl.replace("{x}",x).replace("{y}",y).replace("{z}",this.config.tilesZoom),x:x-coords.minX,y:y-coords.minY,w:tileSize,h:tileSize,d:Math.abs(x-coords.posX)+Math.abs(y-coords.posY),r:scoreLookup[x+"_"+y]||0})}}this.tilesQueue.sort(function(a,b){return b.d+b.r-(a.d+a.r)});this.image=new Image;this.image.addEventListener("load",this.onTileLoaded.bind(this));this.image.addEventListener("error",this.onTileError.bind(this));this.image.setAttribute("src",this.tilesQueue[this.tilesQueue.length-1].url);this.redraw();onComplete()};this.drawTile=function(image){var props=this.tilesQueue.pop();if(image){var tile=image.cloneNode();tile.style.left=props.x*props.w/2+"px";tile.style.top=props.y*props.h/2+"px";tile.style.width=props.w/2+"px";tile.style.height=props.h/2+"px";tile.setAttribute("class","localmap-tile");this.element.appendChild(tile)}if(this.tilesQueue.length>0){this.image.setAttribute("src",this.tilesQueue[this.tilesQueue.length-1].url)}};this.onBitmapLoaded=function(evt){this.drawBitmap()};this.onTileLoaded=function(evt){this.drawTile(evt.target)};this.onTileError=function(evt){this.drawTile(null)};this.start()};Localmap.prototype.Canvas=function(parent,onComplete,onMarkerClicked,onMapFocus){this.parent=parent;this.config=parent.config;this.element=document.createElement("div");this.config.canvasWrapper=this.element;this.start=function(){this.element.setAttribute("class","localmap-canvas");this.element.addEventListener("transitionend",this.onUpdated.bind(this));this.config.container.appendChild(this.element);this.addMarkers()};this.stop=function(){for(var key in this.components)if(this.components[key].stop)this.components[key].stop(this.config);this.config.container.removeChild(this.element)};this.update=function(){this.redraw();for(var key in this.components)if(this.components[key].update)this.components[key].update(this.config)};this.redraw=function(){var container=this.config.container;var element=this.element;var min=this.config.minimum;var max=this.config.maximum;var pos=this.config.position;var centerX=(pos.lon-min.lon_cover)/(max.lon_cover-min.lon_cover)*element.offsetWidth;var centerY=(pos.lat-min.lat_cover)/(max.lat_cover-min.lat_cover)*element.offsetHeight;var zoom=Math.max(Math.min(pos.zoom,max.zoom),min.zoom);var offsetX=-centerX*zoom+container.offsetWidth/2;var offsetY=-centerY*zoom+container.offsetHeight/2;offsetX=Math.max(Math.min(offsetX,0),container.offsetWidth-element.offsetWidth*zoom);offsetY=Math.max(Math.min(offsetY,0),container.offsetHeight-element.offsetHeight*zoom);if(this.config.useTransitions)this.element.className+=" localmap-canvas-transition";element.style.transform="translate3d("+offsetX+"px, "+offsetY+"px, 0px) scale3d("+zoom+", "+zoom+",1)"};this.components={indicator:new parent.Indicator(this,onMarkerClicked,onMapFocus),location:new parent.Location(this)};this.addMarkers=function(){this.components.markers=new parent.Markers(this,onMarkerClicked,this.addBackground.bind(this))};this.addBackground=function(){this.components.background=new parent.Background(this,this.addRoute.bind(this))};this.addRoute=function(){this.components.route=new parent.Route(this,onComplete)};this.onUpdated=function(evt){this.element.className=this.element.className.replace(/ localmap-canvas-transition/g,"")};this.start()};Localmap.prototype.Controls=function(parent){this.parent=parent;this.config=parent.config;this.touches=null;this.inertia={x:0,y:0,z:0};this.elements={};this.range={};this.steps={x:.03,y:.03,z:.03};this.zoom=null;this.last=null;this.start=function(){this.element=document.createElement("nav");this.element.setAttribute("class","localmap-controls");this.config.container.appendChild(this.element);this.elements.zoomin=document.createElement("button");this.elements.zoomin.innerHTML="Zoom in";this.elements.zoomin.setAttribute("class","localmap-controls-zoomin");this.elements.zoomin.addEventListener("click",this.buttonInteraction.bind(this,1.5));this.element.appendChild(this.elements.zoomin);this.elements.zoomout=document.createElement("button");this.elements.zoomout.innerHTML="Zoom out";this.elements.zoomout.setAttribute("class","localmap-controls-zoomout");this.elements.zoomout.addEventListener("click",this.buttonInteraction.bind(this,.667));this.element.appendChild(this.elements.zoomout)};this.stop=function(){this.config.container.removeChild(this.element)};this.update=function(){if(this.zoom!==this.config.position.zoom){this.elements.zoomin.disabled=this.config.position.zoom===this.config.maximum.zoom;this.elements.zoomout.disabled=this.config.position.zoom===this.config.minimum.zoom}this.zoom=this.config.position.zoom};this.reposition=function(hasInertia,controlMethod){window.cancelAnimationFrame(this.animationFrame);this.parent.focus(this.config.position.lon+this.range.lon*-this.inertia.x,this.config.position.lat+this.range.lat*-this.inertia.y,this.config.position.zoom+this.range.zoom*this.inertia.z,false);if(hasInertia&&(Math.abs(this.inertia.x)>.001||Math.abs(this.inertia.y)>.001||Math.abs(this.inertia.z)>.001)){var decay=controlMethod=="touch"?.7:.9;this.inertia.x*=decay;this.inertia.y*=decay;this.inertia.z=0;this.animationFrame=window.requestAnimationFrame(this.reposition.bind(this,hasInertia,controlMethod))}};this.startInteraction=function(method,evt){this.inertia.x=0;this.inertia.y=0;this.inertia.z=0;this.range.lon=this.config.maximum.lon_cover-this.config.minimum.lon_cover;this.range.lat=this.config.maximum.lat_cover-this.config.minimum.lat_cover;this.range.zoom=this.config.maximum.zoom-this.config.minimum.zoom;this.range.x=this.config.canvasWrapper.offsetWidth*this.config.position.zoom;this.range.y=this.config.canvasWrapper.offsetHeight*this.config.position.zoom;this.touches=evt.touches||[{clientX:evt.clientX,clientY:evt.clientY}]};this.moveInteraction=function(method,evt){evt.preventDefault();var touches=evt.touches||[{clientX:evt.clientX,clientY:evt.clientY}];var previous=this.touches;if(previous){this.last=new Date-500;if(touches.length>1&&previous.length>1){var dX=(Math.abs(touches[0].clientX-touches[1].clientX)-Math.abs(previous[0].clientX-previous[1].clientX))/this.config.container.offsetWidth;var dY=(Math.abs(touches[0].clientY-touches[1].clientY)-Math.abs(previous[0].clientY-previous[1].clientY))/this.config.container.offsetHeight;this.inertia.x=(touches[0].clientX-previous[0].clientX+(touches[1].clientX-previous[1].clientX))/2/this.range.x;this.inertia.y=(touches[0].clientY-previous[0].clientY+(touches[1].clientY-previous[1].clientY))/2/this.range.y;this.inertia.z=(dX+dY)/2}else{this.inertia.x=(touches[0].clientX-previous[0].clientX)/this.range.x;this.inertia.y=(touches[0].clientY-previous[0].clientY)/this.range.y;this.inertia.z=0}this.inertia.x=Math.max(Math.min(this.inertia.x,this.steps.x),-this.steps.x);this.inertia.y=Math.max(Math.min(this.inertia.y,this.steps.y),-this.steps.y);this.inertia.z*=this.config.position.zoom;this.reposition(false,method);this.touches=touches}};this.endInteraction=function(method,evt){this.touches=null;this.reposition(true,method)};this.buttonInteraction=function(factor,evt){this.last=new Date-500;this.parent.focus(this.config.position.lon,this.config.position.lat,this.config.position.zoom*factor,true)};this.wheelInteraction=function(method,evt){evt.preventDefault();this.range.lon=this.config.maximum.lon_cover-this.config.minimum.lon_cover;this.range.lat=this.config.maximum.lat_cover-this.config.minimum.lat_cover;this.range.zoom=this.config.maximum.zoom-this.config.minimum.zoom;this.inertia.z+=evt.deltaY>0?this.steps.z:-this.steps.z;this.reposition(true,method)};this.dblclickInteraction=function(method,evt){if(new Date-this.last<250){this.parent.focus(this.config.position.lon,this.config.position.lat,this.config.position.zoom*1.5,true)}this.last=new Date};this.cancelInteraction=function(method,evt){};this.config.container.addEventListener("mousedown",this.startInteraction.bind(this,"mouse"));this.config.container.addEventListener("mousemove",this.moveInteraction.bind(this,"mouse"));this.config.container.addEventListener("mouseup",this.endInteraction.bind(this,"mouse"));this.config.container.addEventListener("wheel",this.wheelInteraction.bind(this,"mouse"));this.config.container.addEventListener("click",this.dblclickInteraction.bind(this,"mouse"));this.config.container.addEventListener("touchstart",this.startInteraction.bind(this,"touch"));this.config.container.addEventListener("touchmove",this.moveInteraction.bind(this,"touch"));this.config.container.addEventListener("touchend",this.endInteraction.bind(this,"touch"));this.config.container.addEventListener("touchcancel",this.cancelInteraction.bind(this,"touch"));this.start()};Localmap.prototype.Credits=function(parent){this.parent=parent;this.config=parent.config;this.element=null;this.start=function(){this.element=document.createElement("figcaption");this.element.setAttribute("class","localmap-credits");this.element.innerHTML=this.config.creditsTemplate;this.config.container.appendChild(this.element)};this.stop=function(){this.config.container.removeChild(this.element)};this.update=function(){};this.start()};Localmap.prototype.Indicator=function(parent,onMarkerClicked,onMapFocus){this.parent=parent;this.config=parent.config;this.element=new Image;this.zoom=null;this.lon=null;this.lat=null;this.start=function(){this.element.setAttribute("src",this.config.markersUrl.replace("{type}","focus"));this.element.setAttribute("alt","");this.element.setAttribute("class","localmap-indicator");this.element.addEventListener("click",this.onIndicatorClicked.bind(this));this.parent.element.appendChild(this.element)};this.stop=function(){this.parent.element.removeChild(this.element)};this.update=function(){if(this.zoom!==this.config.position.zoom)this.resize();if(this.lon!==this.config.indicator.lon&&this.lat!==this.config.indicator.lat)this.reposition();this.zoom=this.config.position.zoom};this.show=function(input){if(input.target)input=input.target;if(!input.getAttribute)input.getAttribute=function(attr){return input[attr]};if(!input.setAttribute)input.setAttribute=function(attr,value){input[attr]=value};var source=input.getAttribute("data-url")||input.getAttribute("src")||input.getAttribute("href")||input.getAttribute("photo");var type=input.getAttribute("data-type");var description=input.getAttribute("data-title")||input.getAttribute("title")||input.getAttribute("description")||input.innerHTML;var lon=input.getAttribute("data-lon")||input.getAttribute("lon");var lat=input.getAttribute("data-lat")||input.getAttribute("lat");var key=this.config.alias||this.config.key;var filename=source?source.split("/").pop():null;var cached=this.config.exifData&&this.config.exifData[key]?this.config.exifData[key][filename]:{};this.config.indicator={photo:filename,type:type,description:description,lon:lon||cached.lon,lat:lat||cached.lat,zoom:this.config.maximum.zoom,referrer:input.referrer||input};if(this.config.indicator.lon&&this.config.indicator.lat){this.onIndicateSuccess()}else{var guideXhr=new XMLHttpRequest;guideXhr.addEventListener("load",this.onExifLoaded.bind(this));guideXhr.open("GET",this.config.exifUrl.replace("{src}",source),true);guideXhr.send()}};this.reset=function(){if(this.config.indicator.referrer)this.config.indicator.referrer.setAttribute("data-localmap","passive");this.config.indicator={icon:null,photo:null,description:null,lon:null,lat:null,zoom:null,origin:null}};this.hide=function(){this.reset();onMapFocus(this.config.position.lon,this.config.position.lat,this.config.position.zoom*.25,true)};this.resize=function(){var scale=1/this.config.position.zoom;this.element.style.transform="scale3d("+scale+", "+scale+", 1)"};this.reposition=function(){var min=this.config.minimum;var max=this.config.maximum;var lon=this.config.indicator.lon;var lat=this.config.indicator.lat;if(lon>min.lon_cover&&lon<max.lon_cover&&lat<min.lat_cover&&lat>max.lat_cover){this.lon=lon;this.lat=lat;this.element.style.cursor=this.config.indicator.description?"pointer":"default";this.element.style.display="block";this.element.style.left=this.config.distortX((lon-min.lon_cover)/(max.lon_cover-min.lon_cover))*100+"%";this.element.style.top=this.config.distortY((lat-min.lat_cover)/(max.lat_cover-min.lat_cover))*100+"%"}else{this.lon=null;this.lat=null;this.element.style.display="none"}};this.onExifLoaded=function(result){var exif=JSON.parse(result.target.response);var deg,min,sec,ref,coords={};if(exif&&exif.GPS){deg=parseInt(exif.GPS.GPSLongitude[0]);min=parseInt(exif.GPS.GPSLongitude[1]);sec=parseInt(exif.GPS.GPSLongitude[2])/100;ref=exif.GPS.GPSLongitudeRef;this.config.indicator.lon=(deg+min/60+sec/3600)*(ref==="W"?-1:1);deg=parseInt(exif.GPS.GPSLatitude[0]);min=parseInt(exif.GPS.GPSLatitude[1]);sec=parseInt(exif.GPS.GPSLatitude[2])/100;ref=exif.GPS.GPSLatitudeRef;this.config.indicator.lat=(deg+min/60+sec/3600)*(ref==="N"?1:-1);this.onIndicateSuccess()}};this.onIndicateSuccess=function(){this.config.indicator.referrer.setAttribute("data-localmap","active");onMapFocus(this.config.indicator.lon,this.config.indicator.lat,this.config.indicator.zoom,true)};this.onIndicatorClicked=function(evt){evt.preventDefault();onMarkerClicked(this.config.indicator)};this.start()};Localmap.prototype.Legend=function(parent,onLegendClicked){this.parent=parent;this.config=parent.config;this.elements=[];this.start=function(){};this.stop=function(){if(this.config.legend)this.config.legend.innerHTML=""};this.update=function(){var key=this.config.key;var guideData=this.config.guideData[key];if(this.config.legend&&this.elements.length===0){this.elements=guideData.markers.map(this.addDefinition.bind(this))}};this.addDefinition=function(markerData){var definitionData={};if(markerData.description){var key=this.config.alias||this.config.key;var image=markerData.photo?this.config.thumbsUrl.replace("{key}",key)+markerData.photo:this.config.markersUrl.replace("{type}",markerData.type);var text=markerData.description||markerData.type;var fragment=document.createDocumentFragment();definitionData.title=document.createElement("dt");definitionData.title.className+=markerData.photo?" localmap-legend-photo":" localmap-legend-icon";definitionData.title.innerHTML='<img alt="'+markerData.type+'" src="'+image+'"/>';definitionData.title.style.backgroundImage='url("'+image+'")';fragment.appendChild(definitionData.title);definitionData.description=document.createElement("dd");definitionData.description.className+=markerData.optional||markerData.detour||markerData.warning?" localmap-legend-alternate":"";definitionData.description.innerHTML="<p>"+text+"</p>";fragment.appendChild(definitionData.description);markerData.referrer=definitionData.title;definitionData.title.addEventListener("click",onLegendClicked.bind(this,markerData));definitionData.description.addEventListener("click",onLegendClicked.bind(this,markerData));this.config.legend.appendChild(fragment)}return definitionData};this.start()};Localmap.prototype.Location=function(parent){this.parent=parent;this.config=parent.config;this.element=new Image;this.zoom=null;this.active=false;this.hotspot=null;this.options={enableHighAccuracy:true};this.start=function(){if("geolocation"in navigator){this.permissions=document.createElement("nav");this.permissions.setAttribute("class","localmap-permissions");this.button=document.createElement("button");this.button.setAttribute("title","Allow geolocation");this.button.innerHTML="Allow geolocation";this.button.setAttribute("class","localmap-permissions-location");this.permissions.appendChild(this.button);this.config.container.appendChild(this.permissions);this.button.addEventListener("click",this.requestPosition.bind(this));this.config.container.addEventListener("mouseup",this.requestPosition.bind(this));this.config.container.addEventListener("touchend",this.requestPosition.bind(this));this.requestPosition()}};this.stop=function(){this.config.container.removeChild(this.permissions)};this.update=function(){if(this.zoom!==this.config.position.zoom)this.resize();this.zoom=this.config.position.zoom};this.resize=function(){var scale=1/this.config.position.zoom;this.element.style.transform="scale3d("+scale+", "+scale+", 1)"};this.requestPosition=function(){if(!this.active){this.locator=navigator.geolocation.watchPosition(this.onReposition.bind(this),this.onPositionFailed.bind(this),this.options);this.element.setAttribute("src",this.config.markersUrl.replace("{type}","location"));this.element.setAttribute("alt","");this.element.setAttribute("class","localmap-location");this.parent.element.appendChild(this.element);this.button.style.display="none"}};this.checkHotSpot=function(lon,lat){var config=this.config;var key=this.config.key;config.hotspots.map(function(marker){if(lon>marker.minLon&&lon<marker.maxLon&&lat>marker.minLat&&lat<marker.maxLat&&this.hotspot!==marker.title){this.hotspot=marker.title;if(config.checkHotspot(marker))config.enterHotspot(marker)}else if((lon<marker.minLon||lon>marker.maxLon||lat<marker.minLat||lat>marker.maxLat)&&this.hotspot===marker.title){this.hotspot=null;if(config.checkHotspot(marker))config.leaveHotspot(marker)}})};this.onReposition=function(position){var min=this.config.minimum;var max=this.config.maximum;var lon=position.coords.longitude;var lat=position.coords.latitude;if(lon>min.lon_cover&&lon<max.lon_cover&&lat<min.lat_cover&&lat>max.lat_cover){this.element.style.display="block";this.element.style.left=this.config.distortX((lon-min.lon_cover)/(max.lon_cover-min.lon_cover))*100+"%";this.element.style.top=this.config.distortY((lat-min.lat_cover)/(max.lat_cover-min.lat_cover))*100+"%";this.checkHotSpot(lon,lat)}else{this.element.style.display="none"}};this.onPositionFailed=function(error){console.log("requestPosition:",error)};this.start()};Localmap.prototype.Markers=function(parent,onClicked,onComplete){this.parent=parent;this.config=parent.config;this.elements=[];this.zoom=null;this.delay=null;this.start=function(){var key=this.config.key;if(this.config.guideData&&this.config.guideData[key]){this.addGuide()}else{var guideXhr=new XMLHttpRequest;guideXhr.addEventListener("load",this.onGuideLoaded.bind(this));guideXhr.open("GET",this.config.guideUrl.replace("{key}",this.config.key),true);guideXhr.send()}};this.stop=function(){};this.update=function(){if(this.config.position.zoom!==this.zoom){clearTimeout(this.delay);this.delay=setTimeout(this.redraw.bind(this),100)}this.zoom=this.config.position.zoom};this.redraw=function(){var scale=1/this.config.position.zoom;for(var key in this.elements){this.elements[key].style.transform="scale3d("+scale+", "+scale+", 1)"}};this.addGuide=function(){var config=this.config;var key=this.config.key;var guideData=this.config.guideData[key];config.alias=guideData.alias?guideData.alias.key:guideData.key;var min=config.minimum;var max=config.maximum;min.lon=guideData.alias?guideData.alias.bounds.west:guideData.bounds.west;min.lat=guideData.alias?guideData.alias.bounds.north:guideData.bounds.north;max.lon=guideData.alias?guideData.alias.bounds.east:guideData.bounds.east;max.lat=guideData.alias?guideData.alias.bounds.south:guideData.bounds.south;min.lon_cover=guideData.bounds.west;min.lat_cover=guideData.bounds.north;max.lon_cover=guideData.bounds.east;max.lat_cover=guideData.bounds.south;var pos=config.position;pos.lon=(max.lon_cover-min.lon_cover)/2+min.lon_cover;pos.lat=(max.lat_cover-min.lat_cover)/2+min.lat_cover;guideData.markers.map(this.addMarker.bind(this));onComplete()};this.addMarker=function(markerData,markerIndex){switch(markerData.type){case"waypoint":markerData.element=this.addWaypoint(markerData,markerIndex);break;case"hotspot":markerData.element=this.addHotspot(markerData,markerIndex);break;default:markerData.element=this.addLandmark(markerData,markerIndex)}if(markerData.element){this.parent.element.appendChild(markerData.element);this.elements.push(markerData.element)}};this.addWaypoint=function(markerData,markerIndex){var min=this.config.minimum;var max=this.config.maximum;var id=markerData.id||"localmap_"+markerIndex;var element=document.createElement("span");element.setAttribute("id",id);element.setAttribute("data-key",id);element.setAttribute("class","localmap-waypoint localmap-index-"+markerIndex);element.addEventListener("click",onClicked.bind(this,markerData));element.style.borderColor=this.config.supportColour(id);element.style.left=this.config.distortX((markerData.lon-min.lon_cover)/(max.lon_cover-min.lon_cover))*100+"%";element.style.top=this.config.distortY((markerData.lat-min.lat_cover)/(max.lat_cover-min.lat_cover))*100+"%";element.style.cursor="pointer";return element};this.addHotspot=function(markerData,markerIndex){var config=this.config;markerData.maxLon=markerData.lon+markerData.radius;markerData.minLon=markerData.lon-markerData.radius;markerData.maxLat=markerData.lat+markerData.radius/1.5;markerData.minLat=markerData.lat-markerData.radius/1.5;this.config.hotspots.push(markerData);return config.checkHotspot(markerData)?this.addLandmark(markerData,markerIndex):null};this.addLandmark=function(markerData,markerIndex){var min=this.config.minimum;var max=this.config.maximum;var id=markerData.id||"localmap_"+markerIndex;var element=new Image;element.setAttribute("src",this.config.markersUrl.replace("{type}",markerData.type));element.setAttribute("title",markerData.description||"");element.setAttribute("class","localmap-marker localmap-index-"+markerIndex);element.setAttribute("id",id);element.setAttribute("data-key",id);element.addEventListener("click",onClicked.bind(this,markerData));element.style.left=this.config.distortX((markerData.lon-min.lon_cover)/(max.lon_cover-min.lon_cover))*100+"%";element.style.top=this.config.distortY((markerData.lat-min.lat_cover)/(max.lat_cover-min.lat_cover))*100+"%";element.style.cursor=markerData.description||markerData.callback?"pointer":null;return element};this.onGuideLoaded=function(evt){this.config.guideData=this.config.guideData||{};this.config.guideData[this.config.key]=JSON.parse(evt.target.response);this.addGuide()};this.start()};Localmap.prototype.Modal=function(parent){this.parent=parent;this.config=parent.config;this.element=null;this.start=function(){this.element=document.createElement("section");this.element.setAttribute("class","localmap-modal localmap-modal-hidden");this.photo=document.createElement("figure");this.photo.setAttribute("class","localmap-modal-photo");this.element.appendChild(this.photo);this.description=document.createElement("article");this.description.setAttribute("class","localmap-modal-content");this.element.appendChild(this.description);this.closer=document.createElement("button");this.closer.setAttribute("class","localmap-modal-closer");this.closer.innerHTML="Close";this.closer.addEventListener("click",this.onDismiss.bind(this));this.element.appendChild(this.closer);this.config.container.appendChild(this.element)};this.stop=function(){this.config.container.removeChild(this.element)};this.update=function(){};this.show=function(markerData){var key=this.config.alias||this.config.key;if(markerData.photo){this.photo.style.backgroundImage="url("+this.config.photosUrl.replace("{key}",key)+markerData.photo+"), url("+this.config.thumbsUrl.replace("{key}",key)+markerData.photo+")";this.photo.className="localmap-modal-photo"}else{this.photo.style.backgroundImage="url("+this.config.markersUrl.replace("{type}",markerData.type)+")";this.photo.className="localmap-modal-icon"}if(markerData.description){this.description.innerHTML="<p>"+markerData.description+"</p>"}else{return false}this.element.className=this.element.className.replace(/-hidden/g,"-visible")};this.onDismiss=function(evt){evt.preventDefault();this.element.className=this.element.className.replace(/-visible/g,"-hidden")};this.start()};Localmap.prototype.Route=function(parent,onComplete){this.parent=parent;this.config=parent.config;this.element=null;this.tracks=[];this.zoom=null;this.delay=null;this.start=function(){var key=this.config.key;this.element=document.createElementNS("http://www.w3.org/2000/svg","svg");this.element.setAttribute("class","localmap-route");this.parent.element.appendChild(this.element);if(this.config.routeData&&this.config.routeData[key]){this.onJsonLoaded(this.config.routeData[key])}else{var routeXhr=new XMLHttpRequest;routeXhr.addEventListener("load",this.onGpxLoaded.bind(this));routeXhr.open("GET",this.config.routeUrl.replace("{key}",key),true);routeXhr.send()}};this.stop=function(){this.parent.element.removeChild(this.element)};this.update=function(){if(this.config.position.zoom!==this.zoom){clearTimeout(this.delay);this.delay=setTimeout(this.redraw.bind(this),100)}this.zoom=this.config.position.zoom};this.draw=function(){var min=this.config.minimum;var max=this.config.maximum;var w=this.parent.element.offsetWidth;var h=this.parent.element.offsetHeight;this.element.setAttribute("viewBox","0 0 "+w+" "+h);this.element.setAttribute("width",w);this.element.setAttribute("height",h);var x,y;var line,points,track;var increments=this.tracks.length>10?25:1;var stroke=4/this.config.position.zoom;for(var a=0,b=this.tracks.length;a<b;a+=1){track=this.tracks[a];line=document.createElementNS("http://www.w3.org/2000/svg","polyline");line.setAttribute("data-key",track.name);line.setAttribute("fill","none");line.setAttribute("stroke",this.config.supportColour(track.name));line.setAttribute("stroke-width",stroke);line.setAttribute("stroke-linejoin","miter");line.setAttribute("stroke-miterlimit",1);if(this.tracks.length>10)line.setAttribute("stroke-dasharray",stroke+" "+stroke);points="";for(var c=0,d=track.coordinates.length;c<d;c+=increments){x=parseInt(this.config.distortX((track.coordinates[c][0]-min.lon_cover)/(max.lon_cover-min.lon_cover))*w);y=parseInt(this.config.distortY((track.coordinates[c][1]-min.lat_cover)/(max.lat_cover-min.lat_cover))*h);points+=" "+x+","+y}line.setAttribute("points",points);line.addEventListener("click",this.onRouteClicked.bind(this,track.name));this.element.appendChild(line)}};this.redraw=function(){var stroke=4/this.config.position.zoom;var lines=this.element.querySelectorAll("polyline");for(var a=0,b=lines.length;a<b;a+=1){lines[a].setAttribute("stroke-width",stroke);if(lines.length>10)lines[a].setAttribute("stroke-dasharray",stroke+" "+stroke)}};this.onRouteClicked=function(name){};this.onJsonLoaded=function(geojson){var features=geojson.features;var name;var coordinates=[];for(var a=0,b=features.length;a<b;a+=1){name=features[a].properties.name;if(features[a].geometry.coordinates[0][0]instanceof Array){coordinates=[].concat.apply([],features[a].geometry.coordinates)}else{coordinates=features[a].geometry.coordinates}this.tracks.push({name:name,coordinates:coordinates})}this.draw();onComplete()};this.onGpxLoaded=function(evt){function extractCoords(source,destination,parentTag,childTag){var a,b,c,d,childNodes,name,coords,parentNodes;parentNodes=source.getElementsByTagName(parentTag);for(a=0,b=parentNodes.length;a<b;a+=1){name=parentNodes[a].getElementsByTagName("name")[0].firstChild.nodeValue;coords=[];childNodes=parentNodes[a].getElementsByTagName(childTag);for(c=0,d=childNodes.length;c<d;c+=1){coords.push([parseFloat(childNodes[c].getAttribute("lon")),parseFloat(childNodes[c].getAttribute("lat")),null])}destination.push({name:name,coordinates:coords})}}extractCoords(evt.target.responseXML,this.tracks,"trk","trkpt");extractCoords(evt.target.responseXML,this.tracks,"rte","rtept");this.draw();onComplete()};this.start()};Localmap.prototype.Scale=function(parent){this.parent=parent;this.config=parent.config;this.element=document.createElement("div");this.zoom=null;this.delay=null;this.start=function(){this.element.setAttribute("class","localmap-scale");this.config.container.appendChild(this.element)};this.stop=function(){this.config.container.removeChild(this.element)};this.update=function(){if(this.config.position.zoom!==this.zoom){clearTimeout(this.delay);this.delay=setTimeout(this.redraw.bind(this),10)}this.zoom=this.config.position.zoom};this.redraw=function(){var mapSize=this.distance({lon:this.config.minimum.lon_cover,lat:this.config.maximum.lat_cover},{lon:this.config.maximum.lon_cover,lat:this.config.maximum.lat_cover});var visible=this.config.container.offsetWidth/this.config.canvasWrapper.offsetWidth/this.config.position.zoom;var scaleSize=visible*mapSize/6;var scale=100,label="100km";if(scaleSize<50){scale=50;label="50km"}if(scaleSize<20){scale=20;label="20km"}if(scaleSize<10){scale=10;label="10km"}if(scaleSize<5){scale=5;label="5km"}if(scaleSize<2){scale=2;label="2km"}if(scaleSize<1){scale=1;label="1km"}if(scaleSize<.5){scale=.5;label="500m"}if(scaleSize<.2){scale=.2;label="200m"}if(scaleSize<.1){scale=.1;label="100m"}this.element.style.width=scale/visible/mapSize*100+"%";this.element.innerHTML=label};this.distance=function(A,B){var lonA=Math.PI*A.lon/180;var lonB=Math.PI*B.lon/180;var latA=Math.PI*A.lat/180;var latB=Math.PI*B.lat/180;var x=(lonA-lonB)*Math.cos((latA+latB)/2);var y=latA-latB;var d=Math.sqrt(x*x+y*y)*6371;return d};this.start()};var Photocylinder=function(config){this.only=function(config){return new this.Main(config,this).init()};this.each=function(config){var _config,_context=this,instances=[];for(var a=0,b=config.elements.length;a<b;a+=1){_config=Object.create(config);_config.element=config.elements[a];instances[a]=new this.Main(_config,_context)}return instances};return config.elements?this.each(config):this.only(config)};if(typeof define!="undefined")define([],function(){return Photocylinder});if(typeof module!="undefined")module.exports=Photocylinder;Photocylinder.prototype.Busy=function(container){this.container=container;this.show=function(){this.spinner=document.createElement("div");this.spinner.className=this.container===document.body?"photocylinder-busy photocylinder-busy-fixed photocylinder-busy-active":"photocylinder-busy photocylinder-busy-active";this.container.appendChild(this.spinner)};this.hide=function(){if(this.spinner&&this.spinner.parentNode){this.spinner.parentNode.removeChild(this.spinner);this.spinner=null}}};Photocylinder.prototype.Fallback=function(parent){this.parent=parent;this.config=parent.config;this.popup=this.config.popup;this.image=this.config.image;this.imageAspect=null;this.wrapper=null;this.wrapperAspect=null;this.fov=null;this.magnification={};this.horizontal={};this.vertical={};this.tracked=null;this.increment=this.config.idle/200;this.auto=true;this.init=function(){this.build();this.render();this.controls();this.resizeListener=this.resize.bind(this);window.addEventListener("resize",this.resizeListener,true)};this.destroy=function(){window.removeEventListener("resize",this.resizeListener,true);window.removeEventListener("deviceorientation",this.tiltListener,true)};this.build=function(){this.wrapper=document.createElement("div");this.wrapper.setAttribute("class","photocylinder photocylinder-fallback");var clonedImage=this.image.cloneNode(true);this.wrapper.appendChild(this.image);this.popup.appendChild(this.wrapper)};this.render=function(){this.imageAspect=this.image.offsetWidth/this.image.offsetHeight;this.magnification.min=1;this.magnification.max=4;this.recentre();this.resize();if(this.imageAspect-this.wrapperAspect>=1)this.animate()};this.controls=function(){this.wrapper.addEventListener("touchstart",this.touch.bind(this,"start"));this.wrapper.addEventListener("touchmove",this.touch.bind(this,"move"));this.wrapper.addEventListener("touchend",this.touch.bind(this,"end"));this.wrapper.addEventListener("mousedown",this.touch.bind(this,"start"));this.wrapper.addEventListener("mousemove",this.touch.bind(this,"move"));this.wrapper.addEventListener("mouseup",this.touch.bind(this,"end"));this.wrapper.addEventListener("mousewheel",this.wheel.bind(this));this.wrapper.addEventListener("DOMMouseScroll",this.wheel.bind(this));this.tiltListener=this.tilt.bind(this);window.addEventListener("deviceorientation",this.tiltListener,true)};this.coords=function(evt){return{x:evt.screenX||evt.touches[0].screenX,y:evt.screenY||evt.touches[0].screenY,z:evt.touches&&evt.touches.length>1?Math.abs(evt.touches[0].screenX-evt.touches[1].screenX+evt.touches[0].screenY-evt.touches[1].screenY):0}};this.recentre=function(){this.magnification.current=this.magnification.min*1.25;this.horizontal.current=.5;this.vertical.current=.5};this.magnify=function(factor){this.magnification.current=Math.max(Math.min(factor,this.magnification.max),this.magnification.min);this.horizontal.min=Math.min(.5-(this.magnification.current-this.wrapperAspect/this.imageAspect)/2,.5);this.horizontal.max=Math.max(1-this.horizontal.min,.5);this.horizontal.current=Math.max(Math.min(this.horizontal.current,this.horizontal.max),this.horizontal.min);this.vertical.min=Math.min(.5-(this.magnification.current-1)/2,.5);this.vertical.max=Math.max(1-this.vertical.min,.5);this.vertical.current=Math.max(Math.min(this.vertical.current,this.vertical.max),this.vertical.min);this.redraw()};this.move=function(horizontal,vertical){this.horizontal.current=Math.max(Math.min(horizontal,this.horizontal.max),this.horizontal.min);this.vertical.current=Math.max(Math.min(vertical,this.vertical.max),this.vertical.min);this.redraw()};this.momentum=function(){if(this.magnification.delta||this.horizontal.delta||this.vertical.delta){this.magnification.delta=Math.abs(this.magnification.delta)>1e-4?this.magnification.delta/1.05:0;this.horizontal.delta=Math.abs(this.horizontal.delta)>.001?this.horizontal.delta/1.05:0;this.vertical.delta=Math.abs(this.vertical.delta)>.001?this.vertical.delta/1.05:0;this.move(this.horizontal.current+this.horizontal.delta,this.vertical.current+this.vertical.delta);this.magnify(this.magnification.current+this.magnification.delta);window.requestAnimationFrame(this.momentum.bind(this))}};this.redraw=function(){this.image.style.transform="translate("+this.horizontal.current*-100+"%, "+this.vertical.current*-100+"%) scale("+this.magnification.current+", "+this.magnification.current+")"};this.animate=function(allow){if(typeof allow==="boolean"){this.auto=allow}if(this.auto){if(this.horizontal.current+this.increment*2>this.horizontal.max)this.increment=-this.config.idle/200;if(this.horizontal.current+this.increment*2<this.horizontal.min)this.increment=this.config.idle/200;var step=this.horizontal.current+this.increment;this.move(step,this.vertical.current);window.requestAnimationFrame(this.animate.bind(this))}};this.tilt=function(evt){this.auto=false;if(this.horizontal.tilted&&this.vertical.tilted&&Math.abs(evt.alpha-this.horizontal.tilted)<45&&Math.abs(evt.beta-this.vertical.tilted)<45){this.move(this.horizontal.current-(evt.alpha-this.horizontal.tilted)/180,this.vertical.current-(evt.beta-this.vertical.tilted)/180)}this.horizontal.tilted=evt.alpha;this.vertical.tilted=evt.beta};this.wheel=function(evt){evt.preventDefault();this.auto=false;this.magnification.delta=0;var coords=this.coords(evt);var distance=evt.deltaY||evt.wheelDeltaY||evt.wheelDelta;this.magnification.delta=distance/this.wrapper.offsetHeight;this.magnify(this.magnification.current+this.magnification.delta);this.momentum()};this.touch=function(phase,evt){evt.preventDefault();var coords,scale=this.magnification.current/this.magnification.min;switch(phase){case"start":this.auto=false;this.magnification.delta=0;this.horizontal.delta=0;this.vertical.delta=0;this.tracked=this.coords(evt);break;case"move":if(this.tracked){coords=this.coords(evt);this.magnification.delta=(this.tracked.z-coords.z)/this.wrapper.offsetWidth*scale*2;this.horizontal.delta=(this.tracked.x-coords.x)/this.wrapper.offsetWidth*scale/this.imageAspect;this.vertical.delta=(this.tracked.y-coords.y)/this.wrapper.offsetHeight*scale;this.move(this.horizontal.current+this.horizontal.delta,this.vertical.current+this.vertical.delta);this.magnify(this.magnification.current-this.magnification.delta);this.tracked.x=coords.x;this.tracked.y=coords.y;this.tracked.z=coords.z}break;case"end":this.tracked=null;this.momentum();break}};this.resize=function(){this.wrapperAspect=this.wrapper.offsetWidth/this.wrapper.offsetHeight;var factor=this.magnification.current||1;var horizontal=this.horizontal.current||.5;var vertical=this.vertical.current||.5;this.magnify(factor);this.move(horizontal,vertical)}};Photocylinder.prototype.Main=function(config,context){this.context=context;this.element=config.element;this.config={container:document.body,spherical:/r(\d+).jpg/i,standalone:false,slicer:"{src}",idle:.1};for(var key in config){this.config[key]=config[key]}this.success=function(url,fov){console.log("success",url);var config=this.config;this.busy.hide();var image=config.image;var isWideEnough=image.naturalWidth&&image.naturalHeight&&image.naturalWidth/image.naturalHeight>3;if(config.standalone){config.popup=config.container;config.popup.innerHTML=""}else{this.popup=new this.context.Popup(this);this.popup.show()}this.stage=!/msie|trident|edge/i.test(navigator.userAgent)&&(this.config.spherical.test(url)||isWideEnough)?new this.context.Stage(this):new this.context.Fallback(this);this.stage.init();if(config.success){config.success(config.popup)}};this.failure=function(url,fov){var config=this.config;this.config.image=null;if(this.popup){config.popup.parentNode.removeChild(config.popup);this.popup=null}if(this.stage){this.stage.destroy();config.stage.parentNode.removeChild(config.stage);this.stage=null}if(config.failure){config.failure(config.popup)}this.busy.hide()};this.destroy=function(){this.stage.destroy()};this.onElementClicked=function(evt){if(evt)evt.preventDefault();this.busy=new this.context.Busy(this.config.container);this.busy.show();var url=this.config.url||this.element.getAttribute("href")||this.element.getAttribute("data-url");var size=this.config.spherical.test(url)?"height=1080&top=0.2&bottom=0.8":"height=1080";this.config.image=new Image;this.config.image.src=this.config.slicer.replace("{src}",url).replace("{size}",size);this.config.image.addEventListener("load",this.success.bind(this,url));this.config.image.addEventListener("error",this.failure.bind(this,url))};if(this.config.element)this.config.element.addEventListener("click",this.onElementClicked.bind(this));if(this.config.url)this.onElementClicked()};Photocylinder.prototype.Popup=function(parent){this.parent=parent;this.config=parent.config;this.show=function(){var config=this.config;if(!config.popup){config.popup=document.createElement("figure");config.popup.className=config.container===document.body?"photocylinder-popup photocylinder-popup-fixed photocylinder-popup-passive":"photocylinder-popup photocylinder-popup-passive";this.addCloser();this.addLocator();config.container.appendChild(config.popup);setTimeout(this.onShow.bind(this),0)}};this.hide=function(){var config=this.config;if(config.popup){config.popup.className=config.popup.className.replace(/-active/gi,"-passive");var _this=this;setTimeout(function(){config.container.removeChild(config.popup);config.popup=null;_this.parent.destroy()},500)}};this.addCloser=function(){var config=this.config;var closer=document.createElement("a");closer.className="photocylinder-closer";closer.innerHTML="x";closer.href="#close";closer.addEventListener("click",this.onHide.bind(this));closer.addEventListener("touchstart",this.onHide.bind(this));config.popup.appendChild(closer)};this.addLocator=function(url){var config=this.config;if(config.located){var locator=document.createElement("a");locator.className="photocylinder-locator";locator.innerHTML="Show on a map";locator.href="#map";locator.addEventListener("click",this.onLocate.bind(this));locator.addEventListener("touchstart",this.onLocate.bind(this));config.popup.appendChild(locator)}};this.onShow=function(){var config=this.config;config.popup.className=config.popup.className.replace(/-passive/gi,"-active");if(config.opened){config.opened(config.element)}};this.onHide=function(evt){var config=this.config;evt.preventDefault();this.hide();if(config.closed){config.closed(config.element)}};this.onLocate=function(evt){var config=this.config;evt.preventDefault();if(config.located){config.located(config.element)}}};Photocylinder.prototype.Stage=function(parent){this.parent=parent;this.config=parent.config;this.popup=this.config.popup;this.image=this.config.image;this.imageAspect=null;this.wrapper=null;this.wrapperAspect=null;this.baseAngle=60;this.baseSize=500;this.obj=null;this.objRow=null;this.objCols=[];this.fov=null;this.magnification={};this.rotation={};this.offset={};this.tracked=null;this.increment=this.config.idle;this.auto=true;this.init=function(){this.build();this.render();this.controls();this.resizeListener=this.resize.bind(this);window.addEventListener("resize",this.resizeListener,true)};this.destroy=function(){window.removeEventListener("resize",this.resizeListener,true);window.removeEventListener("deviceorientation",this.tiltListener,true)};this.build=function(){this.wrapper=document.createElement("div");this.wrapper.setAttribute("class","photocylinder");this.objRow=document.createElement("div");this.objRow.setAttribute("class","photocylinder-obj-row");this.wrapper.appendChild(this.objRow);for(var a=0,b=8;a<b;a+=1){this.objCols[a]=document.createElement("span");this.objCols[a].setAttribute("class","photocylinder-obj-col photocylinder-obj-col-"+a);this.objRow.appendChild(this.objCols[a])}this.wrapper.appendChild(this.image);this.popup.appendChild(this.wrapper);this.config.stage=this.wrapper};this.render=function(){var url=this.image.getAttribute("src");this.fov=this.config.spherical.test(url)?360:180;this.imageAspect=this.image.offsetWidth/this.image.offsetHeight;this.wrapper.className+=this.fov<360?" photocylinder-180":" photocylinder-360";this.magnification.min=Math.max(this.imageAspect*(360/this.fov)*.3,1);this.magnification.max=4;this.magnification.current=this.magnification.min*1.25;this.offset.min=0;this.offset.max=0;for(var a=0,b=this.objCols.length;a<b;a+=1){this.objCols[a].style.backgroundImage="url('"+url+"')"}this.resize();this.recentre();this.animate()};this.controls=function(){this.wrapper.addEventListener("touchstart",this.touch.bind(this,"start"));this.wrapper.addEventListener("touchmove",this.touch.bind(this,"move"));this.wrapper.addEventListener("touchend",this.touch.bind(this,"end"));this.wrapper.addEventListener("mousedown",this.touch.bind(this,"start"));this.wrapper.addEventListener("mousemove",this.touch.bind(this,"move"));this.wrapper.addEventListener("mouseup",this.touch.bind(this,"end"));this.wrapper.addEventListener("mousewheel",this.wheel.bind(this));this.wrapper.addEventListener("DOMMouseScroll",this.wheel.bind(this));this.tiltListener=this.tilt.bind(this);window.addEventListener("deviceorientation",this.tiltListener,true)};this.coords=function(evt){return{x:evt.screenX||evt.touches[0].screenX,y:evt.screenY||evt.touches[0].screenY,z:evt.touches&&evt.touches.length>1?Math.abs(evt.touches[0].screenX-evt.touches[1].screenX+evt.touches[0].screenY-evt.touches[1].screenY):0}};this.recentre=function(){this.rotate(this.fov/2)};this.magnify=function(factor,offset){this.magnification.current=Math.max(Math.min(factor,this.magnification.max),this.magnification.min);this.baseAngle=60*this.wrapperAspect*(this.magnification.min/this.magnification.current);this.offset.max=(this.magnification.current-this.magnification.min)/8;this.offset.min=-1*this.offset.max;this.offset.current=Math.max(Math.min(offset,this.offset.max),this.offset.min);var overscanAngle=(this.baseAngle-360/this.objCols.length)/2;this.rotation.min=this.fov<360?overscanAngle:0;this.rotation.max=this.fov<360?this.fov-this.baseAngle+overscanAngle:this.fov;this.redraw()};this.rotate=function(angle){this.rotation.current=this.fov<360?Math.max(Math.min(angle,this.rotation.max),this.rotation.min):angle%360;this.redraw()};this.momentum=function(){if(this.rotation.delta||this.magnification.delta||this.offset.delta){this.rotation.delta=Math.abs(this.rotation.delta)>.1?this.rotation.delta/1.05:0;this.magnification.delta=Math.abs(this.magnification.delta)>1e-4?this.magnification.delta/1.05:0;this.offset.delta=Math.abs(this.offset.delta)>.001?this.offset.delta/1.05:0;this.rotate(this.rotation.current+this.rotation.delta);this.magnify(this.magnification.current+this.magnification.delta,this.offset.current+this.offset.delta);window.requestAnimationFrame(this.momentum.bind(this))}};this.redraw=function(){var scale=this.wrapper.offsetHeight/this.baseSize;this.objRow.style.transform="translate(-50%, "+(.5+this.offset.current*scale)*-100+"%) scale("+this.magnification.current*scale+") rotateY("+this.rotation.current+"deg)"};this.animate=function(allow){if(typeof allow==="boolean"){this.auto=allow}if(this.auto){if(this.rotation.current+this.increment*2>this.rotation.max)this.increment=-this.config.idle;if(this.rotation.current+this.increment*2<this.rotation.min)this.increment=this.config.idle;var step=this.fov<360?this.rotation.current+this.increment:(this.rotation.current+this.increment)%360;this.rotate(step);window.requestAnimationFrame(this.animate.bind(this))}};this.tilt=function(evt){this.auto=false;if(this.rotation.tilted&&Math.abs(evt.alpha-this.rotation.tilted)<45){this.rotate(this.rotation.current+evt.alpha-this.rotation.tilted)}this.rotation.tilted=evt.alpha};this.wheel=function(evt){evt.preventDefault();this.auto=false;this.magnification.delta=0;var coords=this.coords(evt);var distance=evt.deltaY||evt.wheelDeltaY||evt.wheelDelta;this.magnification.delta=distance/this.wrapper.offsetHeight;this.magnify(this.magnification.current+this.magnification.delta,this.offset.current);this.momentum()};this.touch=function(phase,evt){evt.preventDefault();var coords,scale=this.magnification.current/this.magnification.min;switch(phase){case"start":this.auto=false;this.rotation.delta=0;this.magnification.delta=0;this.offset.delta=0;this.tracked=this.coords(evt);break;case"move":if(this.tracked){coords=this.coords(evt);this.rotation.delta=this.baseAngle*(this.tracked.x-coords.x)/this.wrapper.offsetWidth*scale;this.magnification.delta=(this.tracked.z-coords.z)/this.wrapper.offsetWidth*scale*2;this.offset.delta=(this.tracked.y-coords.y)/this.wrapper.offsetHeight;this.rotate(this.rotation.current+this.rotation.delta);this.magnify(this.magnification.current-this.magnification.delta,this.offset.current+this.offset.delta);this.tracked.x=coords.x;this.tracked.y=coords.y;this.tracked.z=coords.z}break;case"end":this.tracked=null;this.momentum();break}};this.resize=function(){this.wrapperAspect=this.wrapper.offsetWidth/this.wrapper.offsetHeight;var factor=this.magnification.current||1;var offset=this.offset.current||0;var angle=this.rotation.current||this.fov/2;this.magnify(factor,offset);this.rotate(angle)}};var Photowall=function(config){this.only=function(config){return new this.Main(config,this)};this.each=function(config){var _config,_context=this,instances=[];for(var a=0,b=config.elements.length;a<b;a+=1){_config=Object.create(config);_config.element=config.elements[a];instances[a]=new this.Main(_config,_context)}return instances};return config.elements?this.each(config):this.only(config)};if(typeof define!="undefined")define([],function(){return Photowall});if(typeof module!="undefined")module.exports=Photowall;Photowall.prototype.Main=function(config,context){this.config=config;this.context=context;this.element=config.element;this.init=function(){var photos=this.element.getElementsByTagName("img");for(var a=0,b=photos.length;a<b;a+=1){photos[a].style.visibility="hidden";photos[a].parentNode.style.backgroundImage="url('"+photos[a].getAttribute("src")+"')"}return this};this.init()};var Polyfills=function(){this.html5=function(){var a,b,elementsList=["section","nav","article","aside","hgroup","header","footer","dialog","mark","dfn","time","progress","meter","ruby","rt","rp","ins","del","figure","figcaption","video","audio","source","canvas","datalist","keygen","output","details","datagrid","command","bb","menu","legend"];if(navigator.userAgent.match(/msie/gi)){for(a=0,b=elementsList.length;a<b;a+=1){document.createElement(elementsList[a])}}};this.arrayIndexOf=function(){if(!Array.prototype.indexOf){Array.prototype.indexOf=function(obj,start){for(var i=start||0,j=this.length;i<j;i+=1){if(this[i]===obj){return i}}return-1}}};this.arrayIsArray=function(){if(!Array.isArray){Array.isArray=function(arg){return Object.prototype.toString.call(arg)==="[object Array]"}}};this.arrayMap=function(){if(!Array.prototype.map){Array.prototype.map=function(callback,thisArg){var T,A,k;if(this==null){throw new TypeError(" this is null or not defined")}var O=Object(this);var len=O.length>>>0;if(typeof callback!=="function"){throw new TypeError(callback+" is not a function")}if(arguments.length>1){T=thisArg}A=new Array(len);k=0;while(k<len){var kValue,mappedValue;if(k in O){kValue=O[k];mappedValue=callback.call(T,kValue,k,O);A[k]=mappedValue}k++}return A}}};this.querySelectorAll=function(){if(!document.querySelectorAll){document.querySelectorAll=function(a){var b=document,c=b.documentElement.firstChild,d=b.createElement("STYLE");return c.appendChild(d),b.__qsaels=[],d.styleSheet.cssText=a+"{x:expression(document.__qsaels.push(this))}",window.scrollBy(0,0),b.__qsaels}}};this.addEventListener=function(){!window.addEventListener&&function(WindowPrototype,DocumentPrototype,ElementPrototype,addEventListener,removeEventListener,dispatchEvent,registry){WindowPrototype[addEventListener]=DocumentPrototype[addEventListener]=ElementPrototype[addEventListener]=function(type,listener){var target=this;registry.unshift([target,type,listener,function(event){event.currentTarget=target;event.preventDefault=function(){event.returnValue=false};event.stopPropagation=function(){event.cancelBubble=true};event.target=event.srcElement||target;listener.call(target,event)}]);this.attachEvent("on"+type,registry[0][3])};WindowPrototype[removeEventListener]=DocumentPrototype[removeEventListener]=ElementPrototype[removeEventListener]=function(type,listener){for(var index=0,register;register=registry[index];++index){if(register[0]==this&&register[1]==type&&register[2]==listener){return this.detachEvent("on"+type,registry.splice(index,1)[0][3])}}};WindowPrototype[dispatchEvent]=DocumentPrototype[dispatchEvent]=ElementPrototype[dispatchEvent]=function(eventObject){return this.fireEvent("on"+eventObject.type,eventObject)}}(Window.prototype,HTMLDocument.prototype,Element.prototype,"addEventListener","removeEventListener","dispatchEvent",[])};this.consoleLog=function(){var overrideTest=new RegExp("console-log","i");if(!window.console||overrideTest.test(document.querySelectorAll("html")[0].className)){window.console={};window.console.log=function(){var a,b,messages="",reportPanel=document.getElementById("reportPanel");if(!reportPanel){reportPanel=document.createElement("DIV");reportPanel.id="reportPanel";reportPanel.style.background="#fff none";reportPanel.style.border="solid 1px #000";reportPanel.style.color="#000";reportPanel.style.fontSize="12px";reportPanel.style.padding="10px";reportPanel.style.position=navigator.userAgent.indexOf("MSIE 6")>-1?"absolute":"fixed";reportPanel.style.right="10px";reportPanel.style.bottom="10px";reportPanel.style.width="180px";reportPanel.style.height="320px";reportPanel.style.overflow="auto";reportPanel.style.zIndex="100000";reportPanel.innerHTML="&nbsp;";document.body.appendChild(reportPanel)}var reportString=reportPanel.innerHTML.length<1e3?reportPanel.innerHTML:reportPanel.innerHTML.substring(0,800);for(a=0,b=arguments.length;a<b;a+=1){messages+=arguments[a]+"<br/>"}messages+="<hr/>";reportPanel.innerHTML=messages+reportString}}};this.objectCreate=function(){if(typeof Object.create!=="function"){Object.create=function(original){function Clone(){}Clone.prototype=original;return new Clone}}};this.stringTrim=function(){if(!String.prototype.trim){String.prototype.trim=function(){return this.replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g,"")}}if(!String.prototype.ltrim){String.prototype.ltrim=function(){return this.replace(/^\s+/,"")}}if(!String.prototype.rtrim){String.prototype.rtrim=function(){return this.replace(/\s+$/,"")}}if(!String.prototype.fulltrim){String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")}}};this.localStorage=function(){if(!window.localStorage){if(/MSIE 8|MSIE 7|MSIE 6/i.test(navigator.userAgent)){window.localStorage={getItem:function(sKey){if(!sKey||!this.hasOwnProperty(sKey)){return null}return unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1"))},key:function(nKeyId){return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/,"").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[nKeyId])},setItem:function(sKey,sValue){if(!sKey){return}document.cookie=escape(sKey)+"="+escape(sValue)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/";this.length=document.cookie.match(/\=/g).length},length:0,removeItem:function(sKey){if(!sKey||!this.hasOwnProperty(sKey)){return}document.cookie=escape(sKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/";this.length--},hasOwnProperty:function(sKey){return new RegExp("(?:^|;\\s*)"+escape(sKey).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}};window.localStorage.length=(document.cookie.match(/\=/g)||window.localStorage).length}else{Object.defineProperty(window,"localStorage",new function(){var aKeys=[],oStorage={};Object.defineProperty(oStorage,"getItem",{value:function(sKey){return sKey?this[sKey]:null},writable:false,configurable:false,enumerable:false});Object.defineProperty(oStorage,"key",{value:function(nKeyId){return aKeys[nKeyId]},writable:false,configurable:false,enumerable:false});Object.defineProperty(oStorage,"setItem",{value:function(sKey,sValue){if(!sKey){return}document.cookie=escape(sKey)+"="+escape(sValue)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/"},writable:false,configurable:false,enumerable:false});Object.defineProperty(oStorage,"length",{get:function(){return aKeys.length},configurable:false,enumerable:false});Object.defineProperty(oStorage,"removeItem",{value:function(sKey){if(!sKey){return}document.cookie=escape(sKey)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/"},writable:false,configurable:false,enumerable:false});this.get=function(){var iThisIndx;for(var sKey in oStorage){iThisIndx=aKeys.indexOf(sKey);if(iThisIndx===-1){oStorage.setItem(sKey,oStorage[sKey])}else{aKeys.splice(iThisIndx,1)}delete oStorage[sKey]}for(aKeys;aKeys.length>0;aKeys.splice(0,1)){oStorage.removeItem(aKeys[0])}for(var aCouple,iKey,nIdx=0,aCouples=document.cookie.split(/\s*;\s*/);nIdx<aCouples.length;nIdx++){aCouple=aCouples[nIdx].split(/\s*=\s*/);if(aCouple.length>1){oStorage[iKey=unescape(aCouple[0])]=unescape(aCouple[1]);aKeys.push(iKey)}}return oStorage};this.configurable=false;this.enumerable=true})}}};this.functionBind=function(){if(!Function.prototype.bind){Function.prototype.bind=function(oThis){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var aArgs=Array.prototype.slice.call(arguments,1),fToBind=this,fNOP=function(){},fBound=function(){return fToBind.apply(this instanceof fNOP&&oThis?this:oThis,aArgs.concat(Array.prototype.slice.call(arguments)))};fNOP.prototype=this.prototype;fBound.prototype=new fNOP;return fBound}}};this.html5();this.arrayIndexOf();this.arrayIsArray();this.arrayMap();this.querySelectorAll();this.addEventListener();this.consoleLog();this.objectCreate();this.stringTrim();this.localStorage();this.functionBind()};if(typeof define!="undefined")define([],function(){return polyfills});if(typeof module!="undefined")module.exports=polyfills;var requests={randomise:function(url){return url.replace("?","?time="+(new Date).getTime()+"&")},all:function(queue,results){var _this=this,_url=queue.urls[queue.urls.length-1],_results=results||[];this.send({url:_url,post:queue.post||null,contentType:queue.contentType||"text/xml",timeout:queue.timeout||4e3,onTimeout:queue.onTimeout||function(reply){return reply},onProgress:function(reply){queue.onProgress({})},onFailure:queue.onFailure||function(reply){return reply},onSuccess:function(reply){_results.push({url:_url,response:reply.response,responseText:reply.responseText,responseXML:reply.responseXML,status:reply.status});queue.urls.length=queue.urls.length-1;if(queue.urls.length>0){_this.all(queue,_results)}else{queue.onSuccess(_results)}}})},create:function(properties){var serverRequest,_this=this;if(window.XDomainRequest&&properties.xdomain){serverRequest=new XDomainRequest;serverRequest.onload=function(){properties.onSuccess(serverRequest,properties)};serverRequest.onerror=function(){properties.onFailure(serverRequest,properties)};serverRequest.ontimeout=function(){properties.onTimeout(serverRequest,properties)};serverRequest.onprogress=function(){properties.onProgress(serverRequest,properties)}}else if(window.XMLHttpRequest){serverRequest=new XMLHttpRequest;if(serverRequest.timeout){serverRequest.timeout=properties.timeout||0}serverRequest.ontimeout=function(){properties.onTimeout(serverRequest,properties)};serverRequest.onreadystatechange=function(){_this.update(serverRequest,properties)}}else{serverRequest=new ActiveXObject("Microsoft.XMLHTTP");serverRequest.onreadystatechange=function(){_this.update(serverRequest,properties)}}return serverRequest},send:function(properties){properties.onSuccess=properties.onSuccess||function(){};properties.onFailure=properties.onFailure||function(){};properties.onTimeout=properties.onTimeout||function(){};properties.onProgress=properties.onProgress||function(){};var serverRequest=this.create(properties);if(properties.post){try{serverRequest.open("POST",properties.url,true);serverRequest.setRequestHeader("Content-type",properties.contentType||"application/x-www-form-urlencoded");serverRequest.send(properties.post)}catch(errorMessage){properties.onFailure({readyState:-1,status:-1,statusText:errorMessage})}}else{try{serverRequest.open("GET",this.randomise(properties.url),true);serverRequest.send()}catch(errorMessage){properties.onFailure({readyState:-1,status:-1,statusText:errorMessage})}}},update:function(serverRequest,properties){if(serverRequest.readyState===4){switch(serverRequest.status){case 200:properties.onSuccess(serverRequest,properties);break;case 304:properties.onSuccess(serverRequest,properties);break;default:properties.onFailure(serverRequest,properties)}}else{properties.onProgress(serverRequest,properties)}},deserialize:function(text){var parser,xmlDoc;if(window.DOMParser){parser=new DOMParser;xmlDoc=parser.parseFromString(text,"text/xml")}else{xmlDoc=new ActiveXObject("Microsoft.XMLDOM");xmlDoc.async="false";xmlDoc.loadXML(text)}return xmlDoc},decode:function(text){var object;object={};if(typeof JSON!=="undefined"&&typeof JSON.parse!=="undefined"){object=JSON.parse(text)}else if(typeof jQuery!=="undefined"){object=jQuery.parseJSON(text)}return object}};if(typeof define!="undefined")define([],function(){return requests});if(typeof module!="undefined")module.exports=requests;toGeoJSON=function(){"use strict";var removeSpace=/\s*/g,trimSpace=/^\s*|\s*$/g,splitSpace=/\s+/;function okhash(x){if(!x||!x.length)return 0;for(var i=0,h=0;i<x.length;i++){h=(h<<5)-h+x.charCodeAt(i)|0}return h}function get(x,y){return x.getElementsByTagName(y)}function attr(x,y){return x.getAttribute(y)}function attrf(x,y){return parseFloat(attr(x,y))}function get1(x,y){var n=get(x,y);return n.length?n[0]:null}function norm(el){if(el.normalize){el.normalize()}return el}function numarray(x){for(var j=0,o=[];j<x.length;j++)o[j]=parseFloat(x[j]);return o}function clean(x){var o={};for(var i in x)if(x[i])o[i]=x[i];return o}function nodeVal(x){if(x){norm(x)}return x&&x.firstChild&&x.firstChild.nodeValue||""}function coord1(v){return numarray(v.replace(removeSpace,"").split(","))}function coord(v){var coords=v.replace(trimSpace,"").split(splitSpace),o=[];for(var i=0;i<coords.length;i++){o.push(coord1(coords[i]))}return o}function coordPair(x){var ll=[attrf(x,"lon"),attrf(x,"lat")],ele=get1(x,"ele");if(ele)ll.push(parseFloat(nodeVal(ele)));return ll}function fc(){return{type:"FeatureCollection",features:[]}}var serializer;if(typeof XMLSerializer!=="undefined"){serializer=new XMLSerializer}else if(typeof exports==="object"&&typeof process==="object"&&!process.browser){serializer=new(require("xmldom").XMLSerializer)}function xml2str(str){return serializer.serializeToString(str)}var t={kml:function(doc,o){o=o||{};var gj=fc(),styleIndex={},geotypes=["Polygon","LineString","Point","Track"],placemarks=get(doc,"Placemark"),styles=get(doc,"Style");for(var k=0;k<styles.length;k++){styleIndex["#"+attr(styles[k],"id")]=okhash(xml2str(styles[k])).toString(16)}for(var j=0;j<placemarks.length;j++){gj.features=gj.features.concat(getPlacemark(placemarks[j]))}function kmlColor(v){var color,opacity;v=v||"";if(v.substr(0,1)==="#")v=v.substr(1);if(v.length===6||v.length===3)color=v;if(v.length===8){opacity=parseInt(v.substr(0,2),16)/255;color=v.substr(2)}return[color,isNaN(opacity)?undefined:opacity]}function gxCoord(v){return numarray(v.split(" "))}function gxCoords(root){var elems=get(root,"coord","gx"),coords=[];for(var i=0;i<elems.length;i++)coords.push(gxCoord(nodeVal(elems[i])));return coords}function getGeometry(root){var geomNode,geomNodes,i,j,k,geoms=[];if(get1(root,"MultiGeometry"))return getGeometry(get1(root,"MultiGeometry"));if(get1(root,"MultiTrack"))return getGeometry(get1(root,"MultiTrack"));for(i=0;i<geotypes.length;i++){geomNodes=get(root,geotypes[i]);if(geomNodes){for(j=0;j<geomNodes.length;j++){geomNode=geomNodes[j];if(geotypes[i]=="Point"){geoms.push({type:"Point",coordinates:coord1(nodeVal(get1(geomNode,"coordinates")))})}else if(geotypes[i]=="LineString"){geoms.push({type:"LineString",coordinates:coord(nodeVal(get1(geomNode,"coordinates")))})}else if(geotypes[i]=="Polygon"){var rings=get(geomNode,"LinearRing"),coords=[];for(k=0;k<rings.length;k++){coords.push(coord(nodeVal(get1(rings[k],"coordinates"))))}geoms.push({type:"Polygon",coordinates:coords})}else if(geotypes[i]=="Track"){geoms.push({type:"LineString",coordinates:gxCoords(geomNode)})}}}}return geoms}function getPlacemark(root){var geoms=getGeometry(root),i,properties={},name=nodeVal(get1(root,"name")),styleUrl=nodeVal(get1(root,"styleUrl")),description=nodeVal(get1(root,"description")),timeSpan=get1(root,"TimeSpan"),extendedData=get1(root,"ExtendedData"),lineStyle=get1(root,"LineStyle"),polyStyle=get1(root,"PolyStyle");if(!geoms.length)return[];if(name)properties.name=name;if(styleUrl&&styleIndex[styleUrl]){properties.styleUrl=styleUrl;properties.styleHash=styleIndex[styleUrl]}if(description)properties.description=description;if(timeSpan){var begin=nodeVal(get1(timeSpan,"begin"));var end=nodeVal(get1(timeSpan,"end"));properties.timespan={begin:begin,end:end}}if(lineStyle){var linestyles=kmlColor(nodeVal(get1(lineStyle,"color"))),color=linestyles[0],opacity=linestyles[1],width=parseFloat(nodeVal(get1(lineStyle,"width")));if(color)properties.stroke=color;if(!isNaN(opacity))properties["stroke-opacity"]=opacity;if(!isNaN(width))properties["stroke-width"]=width}if(polyStyle){var polystyles=kmlColor(nodeVal(get1(polyStyle,"color"))),pcolor=polystyles[0],popacity=polystyles[1],fill=nodeVal(get1(polyStyle,"fill")),outline=nodeVal(get1(polyStyle,"outline"));if(pcolor)properties.fill=pcolor;if(!isNaN(popacity))properties["fill-opacity"]=popacity;if(fill)properties["fill-opacity"]=fill==="1"?1:0;if(outline)properties["stroke-opacity"]=outline==="1"?1:0}if(extendedData){var datas=get(extendedData,"Data"),simpleDatas=get(extendedData,"SimpleData");for(i=0;i<datas.length;i++){properties[datas[i].getAttribute("name")]=nodeVal(get1(datas[i],"value"))}for(i=0;i<simpleDatas.length;i++){properties[simpleDatas[i].getAttribute("name")]=nodeVal(simpleDatas[i])}}return[{type:"Feature",geometry:geoms.length===1?geoms[0]:{type:"GeometryCollection",geometries:geoms},properties:properties}]}return gj},gpx:function(doc,o){var i,tracks=get(doc,"trk"),routes=get(doc,"rte"),waypoints=get(doc,"wpt"),gj=fc();for(i=0;i<tracks.length;i++){gj.features.push(getTrack(tracks[i]))}for(i=0;i<routes.length;i++){gj.features.push(getRoute(routes[i]))}for(i=0;i<waypoints.length;i++){gj.features.push(getPoint(waypoints[i]))}function getPoints(node,pointname){var pts=get(node,pointname),line=[];for(var i=0;i<pts.length;i++){line.push(coordPair(pts[i]))}return line}function getTrack(node){var segments=get(node,"trkseg"),track=[];for(var i=0;i<segments.length;i++){track.push(getPoints(segments[i],"trkpt"))}return{type:"Feature",properties:getProperties(node),geometry:{type:track.length===1?"LineString":"MultiLineString",coordinates:track.length===1?track[0]:track}}}function getRoute(node){return{type:"Feature",properties:getProperties(node),geometry:{type:"LineString",coordinates:getPoints(node,"rtept")}}}function getPoint(node){var prop=getProperties(node);prop.sym=nodeVal(get1(node,"sym"));return{type:"Feature",properties:prop,geometry:{type:"Point",coordinates:coordPair(node)}}}function getProperties(node){var meta=["name","desc","author","copyright","link","time","keywords"],prop={},k;for(k=0;k<meta.length;k++){prop[meta[k]]=nodeVal(get1(node,meta[k]))}return clean(prop)}return gj}};return t}();if(typeof module!=="undefined")module.exports=toGeoJSON;var SydneyTrainWalks=function(config){this.config=config||{};this.config.extend=function(properties){for(var name in properties){this[name]=properties[name]}};this.init=function(){var parent=document.getElementsByTagName("html")[0];parent.className=navigator.userAgent.match(/ipad;|iphone|ipod touch;/i)?parent.className.replace("ios-false","ios-true"):parent.className.replace("ios-true","ios-false");var storedId=window.localStorage.getItem("id");var storedMode=window.localStorage.getItem("mode")||"map";var startScreen="menu";storedId=this.getQuery("id")||storedId;storedMode=this.getQuery("mode")||storedMode;startScreen=this.getQuery("screen")||startScreen;if(storedId&&storedMode&&GuideData[storedId]){this.update(storedId,storedMode)}else if(startScreen){document.body.className="screen-"+startScreen}setTimeout(this.busy.hide.bind(this),300);document.body.addEventListener("click",this.remoteLink.bind(this))};this.update=function(id,mode){window.localStorage.setItem("id",id);window.localStorage.setItem("mode",mode);document.body.className="screen-"+mode;this.details.update(id);this.footer.update(id)};this.getQuery=function(property){var param=document.location.search.split(property+"=");return param.length>1?param[1].split(/&|#/)[0]:null};this.remoteLink=function(evt){var href=evt.target.getAttribute("href");if(/^http/i.test(href)&&!/.jpg$/i.test(href)){if(typeof cordova!=="undefined"&&cordova.InAppBrowser){evt.preventDefault();cordova.InAppBrowser.open(href,"_system","location=yes")}else{evt.target.setAttribute("target","_blank")}}};if(config){this.busy=new this.Busy(this);this.header=new this.Header(this);this.index=new this.Index(this);this.overview=new this.Overview(this);this.trophies=new this.Trophies(this);this.details=new this.Details(this);this.about=new this.About(this);this.footer=new this.Footer(this);this.init()}};if(typeof define!="undefined")define([],function(){return SydneyTrainWalks});if(typeof module!="undefined")module.exports=SydneyTrainWalks;SydneyTrainWalks.prototype.About=function(parent){this.parent=parent;this.config=parent.config;this.config.extend({about:document.querySelector(".about")});this.init=function(){};if(parent)this.init()};SydneyTrainWalks.prototype.Busy=function(parent){this.parent=parent;this.config=parent.config;this.config.extend({appView:document.querySelector("#appView")});this.init=function(){};this.show=function(){this.config.appView.className=this.config.appView.className.replace(/-ready/g,"-busy")};this.hide=function(){this.config.appView.className=this.config.appView.className.replace(/-busy/g,"-ready")};if(parent)this.init()};SydneyTrainWalks.prototype.Details=function(parent){this.parent=parent;this.config=parent.config;this.returnTo="guide";this.config.extend({title:document.querySelector(".subtitle > h2"),guide:document.querySelector(".guide"),localmap:document.querySelector(".localmap.directions"),return:document.querySelector(".localmap-return"),wall:document.querySelector(".photowall"),titleTemplate:document.getElementById("title-template"),thumbnailTemplate:document.getElementById("thumbnail-template"),trophiesTemplate:document.getElementById("trophies-template"),wallTemplate:document.getElementById("wall-template"),creditTemplate:document.getElementById("credit-template")});this.init=function(){};this.update=function(id){this.updateTitle(id);this.updateGuide(id);this.updateMap(id);this.updateWall(id)};this.updateTitle=function(id){var markers=GuideData[id].markers;this.config.title.innerHTML=this.config.titleTemplate.innerHTML.replace(/{startTransport}/g,markers[0].type).replace(/{startLocation}/g,markers[0].location).replace(/{walkLocation}/g,GuideData[id].location).replace(/{walkDuration}/g,GuideData[id].duration).replace(/{walkDistance}/g,GuideData[id].distance).replace(/{endTransport}/g,markers[markers.length-1].type).replace(/{endLocation}/g,markers[markers.length-1].location);this.config.title.onclick=function(evt){evt.preventDefault();document.body.className=document.body.className.replace(/screen-photos|screen-guide|screen-map/,"screen-menu")}};this.updateGuide=function(id){var _this=this;var description="<p>"+GuideData[id].description.join(" ")+"</p>";var duration=GuideData[id].duration;var distance=GuideData[id].distance;var gpx=this.config.gpx.replace(/{id}/g,id);var markers=GuideData[id].markers;var there="<p>"+markers[0].description+"</p>";var back="<p>"+markers[markers.length-1].description+"</p>";var landmarks=this.updateLandmarks(id);var updated=GuideData[id].updated;var date=new Date(updated).toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric"});this.config.guide.innerHTML=this.config.guideTemplate.innerHTML.replace(/{updated}/g,updated).replace(/{date}/g,date).replace(/{description}/g,description).replace(/{duration}/g,duration).replace(/{distance}/g,distance).replace(/{gpx}/g,gpx).replace(/{there}/g,there).replace(/{back}/g,back).replace(/{landmarks}/g,landmarks);var buttons=document.querySelectorAll(".guide .guide-locate");for(var a=0,b=buttons.length;a<b;a+=1){buttons[a].addEventListener("click",this.onLocate.bind(this,buttons[a]))}this.config.photocylinder=new Photocylinder({elements:document.querySelectorAll(".guide .cylinder-image"),container:this.config.guide,spherical:/fov360|\d{3}_r\d{6}/i,cylindrical:/fov180/i,slicer:this.config.slice,idle:.1,opened:function(link){_this.returnTo="guide";_this.config.guideMap.indicate(link);return true},located:function(link){_this.returnTo="guide";_this.config.guideMap.indicate(link);document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")},closed:function(){_this.config.guideMap.unindicate()}})};this.updateLandmarks=function(id){var _this=this;var prefix=GuideData[id].alias?GuideData[id].alias.key:id;var landmark,landmarks="";GuideData[id].markers.map(function(marker){if(marker.photo){landmark=_this.addThumbnail(prefix,marker);if(marker.optional){landmarks+='<div class="guide-optional">'+landmark+"</div>"}else if(marker.detour){landmarks+='<div class="guide-detour">'+landmark+"</div>"}else if(marker.attention){landmarks+='<div class="guide-attention">'+landmark+"</div>"}else{landmarks+=landmark}}else if(marker.badge){landmark=_this.addTrophy(marker);landmarks+='<div class="guide-trophy">'+landmark+"</div>"}});return landmarks};this.addThumbnail=function(prefix,marker){var thumbnailTemplate=this.config.thumbnailTemplate.innerHTML;return thumbnailTemplate.replace(/{id}/g,prefix).replace(/{src}/g,marker.photo.toLowerCase()).replace(/{description}/g,marker.description)};this.addTrophy=function(marker){var trophiesTemplate=this.config.trophiesTemplate.innerHTML;var storedTrophies=JSON.parse(window.localStorage.getItem("trophies")||"{}");var hasTrophy=storedTrophies[marker.title];return trophiesTemplate.replace(/{icon}/g,hasTrophy?marker.badge:marker.type).replace(/{title}/g,hasTrophy?marker.explanation.join(" "):marker.description).replace(/{type}/g,marker.type).replace(/{lon}/g,marker.lon).replace(/{lat}/g,marker.lat)};this.updateMap=function(id){var prefix=GuideData[id].alias&&GuideData[id].alias.key?GuideData[id].alias.key:id;this.config.return.addEventListener("click",this.onReturnFromMap.bind(this));if(this.config.guideMap){this.config.guideMap.stop()}this.config.guideMap=new Localmap({key:id,container:this.config.localmap,legend:null,thumbsUrl:this.config.local+"/small/{key}/",photosUrl:this.config.remote+"/medium/{key}/",markersUrl:this.config.local+"/img/marker-{type}.svg",exifUrl:this.config.exif,guideUrl:this.config.local+"/guides/{key}.json",routeUrl:this.config.remote+"/gpx/{key}.gpx",mapUrl:this.config.local+"/maps/{key}.jpg",tilesUrl:this.config.local+"/tiles/{z}/{x}/{y}.jpg",tilesZoom:15,guideData:GuideData,routeData:GpxData,exifData:ExifData,creditsTemplate:this.config.creditTemplate.innerHTML,checkHotspot:parent.trophies.check.bind(parent.trophies),enterHotspot:parent.trophies.enter.bind(parent.trophies),leaveHotspot:parent.trophies.leave.bind(parent.trophies)})};this.updateWall=function(id){var _this=this,src,srcs=[],wallTemplate=this.config.wallTemplate.innerHTML,wallHtml="";this.config.wall.className=this.config.wall.className.replace(/-active/g,"-passive");var prefix=GuideData[id].alias&&GuideData[id].alias.key?GuideData[id].alias.key:id;var start=GuideData[id].alias&&GuideData[id].alias.start?GuideData[id].alias.start:0;var end=GuideData[id].alias&&GuideData[id].alias.end?GuideData[id].alias.end+1:null;for(src in ExifData[prefix]){srcs.push(src)}for(var a=start,b=end||srcs.length;a<b;a+=1){wallHtml+=wallTemplate.replace(/{id}/g,prefix).replace(/{src}/g,srcs[a])}this.config.wall.innerHTML="<ul>"+wallHtml+"</ul>";this.config.photowall=new Photowall({element:this.config.wall});this.config.photocylinder=new Photocylinder({elements:document.querySelectorAll(".photowall .cylinder-image"),container:this.config.wall,spherical:/fov360|\d{3}_r\d{6}/i,cylindrical:/fov180/i,slicer:this.config.slice,idle:.1,opened:function(link){_this.returnTo="photos";_this.config.guideMap.indicate(link);return true},located:function(link){_this.returnTo="photos";_this.config.guideMap.indicate(link);document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")},closed:function(){_this.config.guideMap.unindicate()}})};this.onLocate=function(button,evt){evt.preventDefault();this.returnTo="guide";this.config.guideMap.indicate(button);document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")};this.onReturnFromMap=function(evt){evt.preventDefault();document.body.className=document.body.className.replace(/screen-map/,"screen-"+this.returnTo)};if(parent)this.init()};SydneyTrainWalks.prototype.Footer=function(parent){this.parent=parent;this.config=parent.config;this.config.extend({origin:"menu",footer:document.querySelector(".toolbar"),footerTemplate:document.getElementById("footer-template")});this.init=function(){this.update(null);this.config.footer.addEventListener("click",this.onFooterClicked.bind(this));document.addEventListener("backbutton",this.onBackButton.bind(this))};this.update=function(){this.config.footer.innerHTML=this.config.footerTemplate.innerHTML};this.onBackButton=function(evt){console.log("onBackButton",document.body.className);if(!/menu|overview/.test(document.body.className)){evt.preventDefault();window.localStorage.removeItem("id");window.localStorage.removeItem("mode");document.body.className="screen-"+this.config.origin}else if(navigator.app&&navigator.app.exitApp){navigator.app.exitApp()}};this.onFooterClicked=function(evt){var target=evt.target||evt.srcElement,id=target.getAttribute("id");if(id&&id.match(/footer-to-/)){evt.preventDefault();if(id.match(/-menu|-overview|-about|-trophies/)){window.localStorage.removeItem("id");window.localStorage.removeItem("mode");this.config.origin=id.substr(10)}document.body.className="screen-"+id.substr(10)}};if(parent)this.init()};SydneyTrainWalks.prototype.Header=function(parent){this.parent=parent;this.config=parent.config;this.config.extend({header:document.querySelector(".title a"),themeButton:document.querySelector(".toggle-color-scheme")});this.resetView=function(evt){if(evt)evt.preventDefault();document.body.className=document.body.className.replace(/screen-photos|screen-guide|screen-map/,"screen-menu")};this.cycleTheme=function(evt){if(evt)evt.preventDefault();var theme=document.body.getAttribute("data-color-scheme");switch(theme){case"dark":document.body.setAttribute("data-color-scheme","light");window.localStorage.setItem("scheme","light");break;case"light":document.body.setAttribute("data-color-scheme","auto");window.localStorage.setItem("scheme","auto");break;default:document.body.setAttribute("data-color-scheme","dark");window.localStorage.setItem("scheme","dark")}};this.init=function(){this.config.header.addEventListener("click",this.resetView.bind(this));this.config.themeButton.addEventListener("click",this.cycleTheme.bind(this));document.body.setAttribute("data-color-scheme",window.localStorage.getItem("scheme")||"auto")};if(parent)this.init()};SydneyTrainWalks.prototype.Index=function(parent){this.parent=parent;this.searchFor="";this.searchDelay=null;this.sortBy="length";this.config=parent.config;this.config.extend({searchForm:document.getElementById("sorting"),searchInput:document.querySelector(".searching-label input"),sortSelect:document.querySelector(".sorting-label select"),filterSelect:document.querySelector(".filtering-label select"),menu:document.querySelector(".navigation > menu"),titleTemplate:document.getElementById("title-template"),menuTemplate:document.getElementById("menu-template"),guideTemplate:document.getElementById("guide-template")});this.init=function(){var searchForm=this.config.searchForm;var searchInput=this.config.searchInput;var sortSelect=this.config.sortSelect;var filterSelect=this.config.filterSelect;this.update();this.config.menu.addEventListener("click",this.onMenuClicked.bind(this));searchInput.addEventListener("focus",this.onFieldFocus.bind(this));searchInput.addEventListener("blur",this.onSearchChanged.bind(this,searchInput));searchInput.addEventListener("keyup",this.onSearchChanged.bind(this,searchInput));searchInput.addEventListener("change",this.onSearchChanged.bind(this,searchInput));sortSelect.addEventListener("focus",this.onFieldFocus.bind(this));sortSelect.addEventListener("change",this.onSortSelected.bind(this,sortSelect));filterSelect.addEventListener("focus",this.onFieldFocus.bind(this));filterSelect.addEventListener("change",this.onFilterSelected.bind(this,filterSelect));searchForm.addEventListener("submit",this.onSearchSubmitted.bind(this,searchInput));if(!/MSIE/i.test(navigator.userAgent)){searchInput.addEventListener("click",this.onSearchReset.bind(this,searchInput))}else{searchInput.style.backgroundImage="none"}};this.update=function(){var id,markers,menuHtml="",titleHtml="";var menuTemplate=this.config.menuTemplate.innerHTML;var titleTemplate=this.config.titleTemplate.innerHTML;var guideIds=Object.keys(GuideData);var searchedIds=this.searchGuide(guideIds,this.searchFor);var filteredIds=this.filterGuide(searchedIds,this.filterBy);var sortedIds=this.sortGuide(filteredIds,this.sortBy);this.mirrorResults(guideIds,sortedIds);for(var a=0,b=sortedIds.length;a<b;a+=1){id=sortedIds[a];markers=GuideData[id].markers;titleHtml=titleTemplate.replace(/{startTransport}/g,markers[0].type).replace(/{startLocation}/g,markers[0].location).replace(/{walkLocation}/g,GuideData[id].location).replace(/{walkDuration}/g,GuideData[id].duration).replace(/{walkDistance}/g,GuideData[id].distance).replace(/{endTransport}/g,markers[markers.length-1].type).replace(/{endLocation}/g,markers[markers.length-1].location);menuHtml+=menuTemplate.replace(/{id}/g,id).replace(/{title}/g,titleHtml)}this.config.menu.innerHTML=menuHtml===""?'<li class="no-results">No results...</li>':menuHtml};this.searchGuide=function(guideIds,keyword){var id,locations="",searched=[],search=new RegExp(keyword,"i");guideIds.map(function(id){var guide=GuideData[id];if(guide.location&&guide.markers){locations=guide.location+" "+guide.markers[0].location+" "+guide.markers[guide.markers.length-1].location;if(search.test(locations)){searched.push(id)}}});return searched};this.sortGuide=function(guideIds,option){var id,unsorted=guideIds,sorted=[];switch(option){case"start":sorted=unsorted.sort(function(a,b){a=GuideData[a].markers[0].location;b=GuideData[b].markers[0].location;return a<b?-1:1});break;case"finish":sorted=unsorted.sort(function(a,b){a=GuideData[a].markers[GuideData[a].markers.length-1].location;b=GuideData[b].markers[GuideData[b].markers.length-1].location;return a<b?-1:1});break;case"region":sorted=unsorted.sort(function(a,b){a=GuideData[a].location;b=GuideData[b].location;return a<b?-1:1});break;case"duration":sorted=unsorted.sort(function(a,b){a=GuideData[a].duration;b=GuideData[b].duration;return a-b});break;case"length":sorted=unsorted.sort(function(a,b){a=GuideData[a].distance;b=GuideData[b].distance;return a-b});break;case"revised":sorted=unsorted.sort(function(a,b){a=new Date(GuideData[a].updated);b=new Date(GuideData[b].updated);return b-a});break;default:sorted=unsorted}return sorted};this.filterGuide=function(guideIds,option){var id,unfiltered=guideIds,filtered=[];switch(option){case"public":unfiltered.map(function(a){var markers=GuideData[a].markers;var first=markers[0];var last=markers[markers.length-1];if(first.type!=="car"&&last.type!=="car")filtered.push(a)});break;case"car":unfiltered.map(function(a){var markers=GuideData[a].markers;var first=markers[0];var last=markers[markers.length-1];if(first.type==="car"||last.type==="car")filtered.push(a)});break;case"toilets":unfiltered.map(function(a){var markers=GuideData[a].markers;var toilets=markers.reduce(function(accumulator,marker){accumulator.found=accumulator.found!=="undefined"?marker.type==="toilet"||accumulator.found:false;return accumulator});if(toilets.found)filtered.push(a)});break;case"looped":unfiltered.map(function(a){var markers=GuideData[a].markers;var first=markers[0];var last=markers[markers.length-1];if(first.location===last.location)filtered.push(a)});break;case"rain":unfiltered.map(function(a){if(GuideData[a].rain)filtered.push(a)});break;case"fireban":unfiltered.map(function(a){if(GuideData[a].fireban)filtered.push(a)});break;default:filtered=unfiltered}return filtered};this.mirrorResults=function(guideIds,sortedIds){guideIds.map(function(id){var visibility=sortedIds.indexOf(id)>-1?"visible":"hidden";var elements=document.querySelectorAll('[data-key="'+id+'"]');for(var a=0,b=elements.length;a<b;a+=1){elements[a].style.visibility=visibility}})};this.onFieldFocus=function(evt){window.localStorage.setItem("id",null);window.localStorage.setItem("mode",null)};this.onSearchReset=function(input,evt){if(input.offsetWidth-evt.layerX<32){evt.preventDefault();input.blur();input.value="";this.searchFor="";this.update()}};this.onSearchSubmitted=function(input,evt){evt.preventDefault();this.searchFor=input.value.trim();this.update();input.blur()};this.onSearchChanged=function(input,evt){var _this=this;clearTimeout(_this.searchDelay);this.searchDelay=setTimeout(function(){_this.searchFor=input.value.trim();_this.update()},700)};this.onSortSelected=function(select,evt){this.sortBy=select.value;this.update()};this.onFilterSelected=function(select,evt){this.filterBy=select.value;this.update()};this.onMenuClicked=function(evt){evt.preventDefault();var id,target=evt.target||evt.srcElement;while(!id){id=target.getAttribute("data-id");target=target.parentNode}this.parent.update(id,"map")};if(parent)this.init()};SydneyTrainWalks.prototype.Overview=function(parent){this.parent=parent;this.config=parent.config;this.overviewMap=null;this.awaitTimeout=null;this.config.extend=function(properties){for(var name in properties){this[name]=properties[name]}};this.config.extend({overview:document.querySelector(".localmap.overview"),creditTemplate:document.getElementById("credit-template")});this.init=function(){var observer=this.awaitView.bind(this);var mutationObserver=new MutationObserver(observer);mutationObserver.observe(document.body,{attributes:true,attributeFilter:["id","class","style"],subtree:true});this.awaitView()};this.awaitView=function(mutations,observer){var overview=this.config.overview;var resolver=this.createMap.bind(this);clearTimeout(this.awaitTimeout);this.awaitTimeout=setTimeout(function(){if(overview.getBoundingClientRect().right>0){resolver();if(observer)observer.disconnect()}},100)};this.createMap=function(){if(this.localmap)return false;this.localmap=new Localmap({key:"_index",container:this.config.overview,legend:null,thumbsUrl:null,photosUrl:null,markersUrl:this.config.local+"/img/marker-{type}.svg",exifUrl:null,guideUrl:null,routeUrl:null,mapUrl:this.config.local+"/maps/{key}.jpg",tilesUrl:this.config.local+"/tiles/{z}/{x}/{y}.jpg",tilesZoom:11,guideData:this.processMarkers(),routeData:this.mergeRoutes(),exifData:null,distortX:function(x){return x},distortY:function(y){return y-(-2*y*y+2*y)/150},creditsTemplate:this.config.creditTemplate.innerHTML,supportColour:function(name){var colours=["red","darkorange","green","teal","blue","purple","black"];var index=name.split("").reduce(function(a,b){a=typeof a=="string"?a.charCodeAt():a;b=typeof b=="string"?b.charCodeAt():b;return a+b});return colours[index%colours.length]}})};this.processMarkers=function(){var _this=this;GuideData["_index"].markers.map(function(marker){marker.type="waypoint";marker.description="";marker.callback=_this.onMarkerClicked.bind(_this,marker.id)});return GuideData};this.mergeRoutes=function(){var routes={_index:{features:[]}};if(typeof GpxData!="undefined"){for(var key in GpxData){if(!GuideData[key].alias){routes["_index"].features=routes["_index"].features.concat(GpxData[key].features)}}}return routes};this.onMarkerClicked=function(id,evt){this.parent.update(id,"map")};if(parent)this.init()};SydneyTrainWalks.prototype.Trophies=function(parent){this.parent=parent;this.config=parent.config;this.config.extend({trophies:document.querySelector(".trophies ul"),trophiesTemplate:document.getElementById("trophies-template"),trophy:document.querySelector(".trophy"),trophyTemplate:document.getElementById("trophy-template")});this.init=function(){var trophy=this.config.trophy;this.update()};this.update=function(){var guides=GuideData;var container=this.config.trophies;container.innerHTML="";var a,b,id,marker,duplicates={},trophies=[];for(id in guides){for(a=0,b=guides[id].markers.length;a<b;a+=1){marker=guides[id].markers[a];if(marker.type==="hotspot"&&!duplicates[marker.title]){duplicates[marker.title]=true;trophies.push({id:id,marker:marker})}}}trophies.sort(function(a,b){return a.marker.title>b.marker.title?1:-1});var _this=this;trophies.map(function(trophy){var wrapper,link;wrapper=document.createElement("li");link=_this.getTrophy(trophy.marker.title)?_this.addBadge(trophy.id,trophy.marker):_this.addMystery(trophy.id,trophy.marker);wrapper.appendChild(link);container.appendChild(wrapper)})};this.addBadge=function(id,marker){var link=document.createElement("a");var template=this.config.trophiesTemplate;link.innerHTML+=template.innerHTML.replace(/{icon}/g,marker.badge).replace(/{title}/g,marker.title);link.setAttribute("class","trophies-active");link.addEventListener("click",this.details.bind(this,marker));return link};this.addMystery=function(id,marker){var link=document.createElement("a");var template=this.config.trophiesTemplate;link.innerHTML+=template.innerHTML.replace(/{icon}/g,marker.type).replace(/{title}/g,"???");link.setAttribute("class","trophies-passive");link.addEventListener("click",this.deeplink.bind(this,id));return link};this.getTrophy=function(title){var storedTrophies=JSON.parse(window.localStorage.getItem("trophies")||"{}");return storedTrophies[title]};this.setTrophy=function(title){var storedTrophies=JSON.parse(window.localStorage.getItem("trophies")||"{}");storedTrophies[title]=true;window.localStorage.setItem("trophies",JSON.stringify(storedTrophies))};this.check=function(data){return!this.getTrophy(data.title)};this.enter=function(data){if(!this.getTrophy(data.title)){this.details(data);this.update()}};this.leave=function(data){var trophy=this.config.trophy;trophy.className=trophy.className.replace(/ trophy-active/g,"")};var long2tile=function long2tile(lon,zoom){return Math.floor((lon+180)/360*Math.pow(2,zoom))};var lat2tile=function lat2tile(lat,zoom){return Math.floor((1-Math.log(Math.tan(lat*Math.PI/180)+1/Math.cos(lat*Math.PI/180))/Math.PI)/2*Math.pow(2,zoom))};var tile2long=function tile2long(x,z){return x/Math.pow(2,z)*360-180};var tile2lat=function tile2lat(y,z){var n=Math.PI-2*Math.PI*y/Math.pow(2,z);return 180/Math.PI*Math.atan(.5*(Math.exp(n)-Math.exp(-n)))};this.details=function(marker){var guides=GuideData;var container=this.config.trophy;var template=this.config.trophyTemplate;var tile=[15,long2tile(marker.lon,15),lat2tile(marker.lat,15)];var background=marker.title.replace(/:|\.|\,|\'|\s|\?|\!/g,"_").toLowerCase().trim();container.innerHTML=template.innerHTML.replace(/{icon}/g,marker.badge).replace(/{title}/g,marker.title).replace(/{tile}/g,"trophies/"+background).replace(/{background}/g,"trophies/"+background).replace(/{description}/g,"<p>"+marker.explanation.join("</p><p>")+"</p>");var closer=container.querySelector("footer button");closer.addEventListener("click",this.close.bind(this,marker,container));container.className+=" trophy-active"};this.deeplink=function(id){this.parent.update(id,"map")};this.close=function(marker,container,evt){evt.preventDefault();this.setTrophy(marker.title);this.update();container.className=container.className.replace(/ trophy-active/g,"")};if(parent)this.init()};