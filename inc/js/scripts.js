var SydneyTrainWalks=function(t){this.config=t||{},this.config.extend=function(t){for(var e in t)this[e]=t[e]},this.init=function(){var t=document.getElementsByTagName("html")[0];t.className=navigator.userAgent.match(/ipad;|iphone|ipod touch;/i)?t.className.replace("ios-false","ios-true"):t.className.replace("ios-true","ios-false");var e=window.localStorage.getItem("id"),i=window.localStorage.getItem("mode")||"map";e=this.getQuery("id")||e,i=this.getQuery("mode")||i,e&&i&&GuideData[e]&&this.update(e,i),setTimeout(this.busy.hide.bind(this),300),document.body.addEventListener("click",this.remoteLink.bind(this))},this.update=function(t,e){window.localStorage.setItem("id",t),window.localStorage.setItem("mode",e),document.body.className="screen-"+e,this.details.update(t),this.footer.update(t)},this.getQuery=function(t){var e=document.location.search.split(t+"=");return 1<e.length?e[1].split(/&|#/)[0]:null},this.remoteLink=function(t){var e=t.target.getAttribute("href");/^http/i.test(e)&&!/.jpg$/i.test(e)&&(t.preventDefault(),window.open(e,"_system","location=yes"))},t&&(this.busy=new this.Busy(this),this.index=new this.Index(this),this.overview=new this.Overview(this),this.details=new this.Details(this),this.about=new this.About(this),this.footer=new this.Footer(this),this.init())};"undefined"!=typeof define&&define([],function(){return SydneyTrainWalks}),"undefined"!=typeof module&&(module.exports=SydneyTrainWalks),SydneyTrainWalks.prototype.About=function(t){this.parent=t,this.config=t.config,this.config.extend({about:document.querySelector(".about")}),this.init=function(){},t&&this.init()},SydneyTrainWalks.prototype.Busy=function(t){this.parent=t,this.config=t.config,this.config.extend({appView:document.querySelector("#appView")}),this.init=function(){},this.show=function(){this.config.appView.className=this.config.appView.className.replace(/-ready/g,"-busy")},this.hide=function(){this.config.appView.className=this.config.appView.className.replace(/-busy/g,"-ready")},t&&this.init()},SydneyTrainWalks.prototype.Details=function(t){this.parent=t,this.config=t.config,this.returnTo="guide",this.config.extend({title:document.querySelector(".subtitle > h2"),guide:document.querySelector(".guide"),localmap:document.querySelector(".localmap.directions"),return:document.querySelector(".localmap-return"),wall:document.querySelector(".photowall"),titleTemplate:document.getElementById("title-template"),thumbnailTemplate:document.getElementById("thumbnail-template"),wallTemplate:document.getElementById("wall-template"),creditTemplate:document.getElementById("credit-template")}),this.init=function(){},this.update=function(t){this.updateTitle(t),this.updateGuide(t),this.updateMap(t),this.updateWall(t)},this.updateTitle=function(t){var e=GuideData[t].markers;this.config.title.innerHTML=this.config.titleTemplate.innerHTML.replace(/{startTransport}/g,e[0].type).replace(/{startLocation}/g,e[0].location).replace(/{walkLocation}/g,GuideData[t].location).replace(/{walkDuration}/g,GuideData[t].duration).replace(/{walkDistance}/g,GuideData[t].distance).replace(/{endTransport}/g,e[e.length-1].type).replace(/{endLocation}/g,e[e.length-1].location),this.config.title.onclick=function(t){document.location.replace("./")}},this.updateGuide=function(t){var e=this,i="<p>"+GuideData[t].description.join(" ")+"</p>",n=GuideData[t].duration,o=GuideData[t].distance,s=this.config.gpx.replace(/{id}/g,t),a=GuideData[t].markers,r="<p>"+a[0].description+"</p>",h="<p>"+a[a.length-1].description+"</p>",c=this.updateLandmarks(t),l=GuideData[t].updated,u=new Date(l).toLocaleDateString("en-AU",{year:"numeric",month:"short",day:"numeric"});this.config.guide.innerHTML=this.config.guideTemplate.innerHTML.replace(/{updated}/g,l).replace(/{date}/g,u).replace(/{description}/g,i).replace(/{duration}/g,n).replace(/{distance}/g,o).replace(/{gpx}/g,s).replace(/{there}/g,r).replace(/{back}/g,h).replace(/{landmarks}/g,c);for(var d=document.querySelectorAll(".guide .guide-locate"),m=0,p=d.length;m<p;m+=1)d[m].addEventListener("click",this.onLocate.bind(this,d[m]));this.config.photocylinder=new Photocylinder({elements:document.querySelectorAll(".guide .cylinder-image"),container:this.config.guide,spherical:/fov360|\d{3}_r\d{6}/i,cylindrical:/fov180/i,slicer:this.config.slice,idle:.1,opened:function(t){return e.returnTo="guide",e.config.guideMap.indicate(t),!0},located:function(t){e.returnTo="guide",e.config.guideMap.indicate(t),document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")},closed:function(){e.config.guideMap.unindicate()}})},this.updateLandmarks=function(t){var e,i=GuideData[t].alias?GuideData[t].alias.key:t,n="",o=this.config.thumbnailTemplate.innerHTML;return GuideData[t].markers.map(function(t){t.photo&&(e=o.replace(/{id}/g,i).replace(/{src}/g,t.photo.toLowerCase()).replace(/{description}/g,t.description),t.optional?n+='<div class="guide-optional">'+e+"</div>":t.detour?n+='<div class="guide-detour">'+e+"</div>":t.attention?n+='<div class="guide-attention">'+e+"</div>":n+=e)}),n},this.updateMap=function(t){GuideData[t].alias&&GuideData[t].alias.key&&GuideData[t].alias.key;this.config.return.addEventListener("click",this.onReturnFromMap.bind(this)),this.config.guideMap&&this.config.guideMap.stop(),this.config.guideMap=new Localmap({key:t,container:this.config.localmap,legend:null,thumbsUrl:this.config.local+"/small/{key}/",photosUrl:this.config.remote+"/medium/{key}/",markersUrl:this.config.local+"/img/marker-{type}.svg",exifUrl:this.config.exif,guideUrl:this.config.local+"/guides/{key}.json",routeUrl:this.config.remote+"/gpx/{key}.gpx",mapUrl:this.config.local+"/maps/{key}.jpg",tilesUrl:this.config.local+"/tiles/{z}/{x}/{y}.jpg",tilesZoom:15,guideData:GuideData,routeData:GpxData,exifData:ExifData,creditsTemplate:this.config.creditTemplate.innerHTML})},this.updateWall=function(t){var e,i=this,n=[],o=this.config.wallTemplate.innerHTML,s="";this.config.wall.className=this.config.wall.className.replace(/-active/g,"-passive");var a=GuideData[t].alias&&GuideData[t].alias.key?GuideData[t].alias.key:t,r=GuideData[t].alias&&GuideData[t].alias.start?GuideData[t].alias.start:0,h=GuideData[t].alias&&GuideData[t].alias.end?GuideData[t].alias.end+1:null;for(e in ExifData[a])n.push(e);for(var c=r,l=h||n.length;c<l;c+=1)s+=o.replace(/{id}/g,a).replace(/{src}/g,n[c]);this.config.wall.innerHTML="<ul>"+s+"</ul>",this.config.photowall=new Photowall({element:this.config.wall}),this.config.photocylinder=new Photocylinder({elements:document.querySelectorAll(".photowall .cylinder-image"),container:this.config.wall,spherical:/fov360|\d{3}_r\d{6}/i,cylindrical:/fov180/i,slicer:this.config.slice,idle:.1,opened:function(t){return i.returnTo="photos",i.config.guideMap.indicate(t),!0},located:function(t){i.returnTo="photos",i.config.guideMap.indicate(t),document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")},closed:function(){i.config.guideMap.unindicate()}})},this.onLocate=function(t,e){e.preventDefault(),this.returnTo="guide",this.config.guideMap.indicate(t),document.body.className=document.body.className.replace(/screen-photos|screen-guide/,"screen-map")},this.onReturnFromMap=function(t){t.preventDefault(),document.body.className=document.body.className.replace(/screen-map/,"screen-"+this.returnTo)},this.onSignExpanded=function(t,e,i){for(var n=t.className.match(/-long/),o=0,s=e.length;o<s;o+=1)e[o].className=e[o].className.replace("-long","-short");n||(t.className=t.className.replace("-short","-long"))},t&&this.init()},SydneyTrainWalks.prototype.Footer=function(t){this.parent=t,this.config=t.config,this.config.extend({origin:"menu",footer:document.querySelector(".toolbar"),footerTemplate:document.getElementById("footer-template")}),this.init=function(){this.update(null),this.config.footer.addEventListener("click",this.onFooterClicked.bind(this)),document.addEventListener("backbutton",this.onBackButton.bind(this))},this.update=function(){this.config.footer.innerHTML=this.config.footerTemplate.innerHTML},this.onBackButton=function(t){console.log("onBackButton",document.body.className),/menu|overview/.test(document.body.className)?navigator.app&&navigator.app.exitApp&&navigator.app.exitApp():(t.preventDefault(),window.localStorage.removeItem("id"),window.localStorage.removeItem("mode"),document.body.className="screen-"+this.config.origin)},this.onFooterClicked=function(t){var e=(t.target||t.srcElement).getAttribute("id");e&&e.match(/footer-to-/)&&(t.preventDefault(),e.match(/-menu|-overview|-about/)&&(window.localStorage.removeItem("id"),window.localStorage.removeItem("mode"),this.config.origin=e.substr(10)),document.body.className="screen-"+e.substr(10))},t&&this.init()},SydneyTrainWalks.prototype.Index=function(t){this.parent=t,this.searchFor="",this.searchDelay=null,this.sortBy="length",this.config=t.config,this.config.extend({sorting:document.getElementById("sorting"),menu:document.querySelector(".navigation > menu"),titleTemplate:document.getElementById("title-template"),menuTemplate:document.getElementById("menu-template"),guideTemplate:document.getElementById("guide-template")}),this.init=function(){var t=this.config.sorting.getElementsByTagName("input")[0],e=this.config.sorting.getElementsByTagName("select")[0];this.update(),this.config.menu.addEventListener("click",this.onMenuClicked.bind(this)),t.addEventListener("focus",this.onSearchFocus.bind(this,t)),t.addEventListener("blur",this.onSearchChanged.bind(this,t)),t.addEventListener("keyup",this.onSearchChanged.bind(this,t)),t.addEventListener("change",this.onSearchChanged.bind(this,t)),e.addEventListener("focus",this.onSortingFocus.bind(this,e)),e.addEventListener("change",this.onSortingSelected.bind(this,e)),t.parentNode.parentNode.addEventListener("submit",this.onSearchSubmitted.bind(this,t)),/MSIE/i.test(navigator.userAgent)?t.style.backgroundImage="none":t.addEventListener("click",this.onSearchReset.bind(this,t))},this.update=function(){for(var t,e,i=this.config.menuTemplate.innerHTML,n=this.config.titleTemplate.innerHTML,o="",s="",a=this.searchGuide(GuideData,this.searchFor),r=this.sortGuide(GuideData,this.sortBy),h=0,c=r.length;h<c;h+=1)t=r[h],-1<a.indexOf(t)&&"_index"!==t&&(e=GuideData[t].markers,s=n.replace(/{startTransport}/g,e[0].type).replace(/{startLocation}/g,e[0].location).replace(/{walkLocation}/g,GuideData[t].location).replace(/{walkDuration}/g,GuideData[t].duration).replace(/{walkDistance}/g,GuideData[t].distance).replace(/{endTransport}/g,e[e.length-1].type).replace(/{endLocation}/g,e[e.length-1].location),o+=i.replace(/{id}/g,t).replace(/{title}/g,s));this.config.menu.innerHTML=""===o?'<li class="no-results">No results...</li>':o},this.searchGuide=function(t,e){var i,n,o=[],s=new RegExp(e,"i");for(i in t)n=t[i].location,t[i].markers.map(function(t){t.location&&(n+=" "+t.location)}),s.test(n)&&o.push(i);return o},this.sortGuide=function(i,t){var e,n=[],o=[];for(e in i)n.push(e);switch(t){case"start":o=n.sort(function(t,e){return(t=i[t].markers[0].location)<(e=i[e].markers[0].location)?-1:1});break;case"finish":o=n.sort(function(t,e){return(t=i[t].markers[markers.length-1].location)<(e=i[e].markers[markers.length-1].location)?-1:1});break;case"region":o=n.sort(function(t,e){return(t=i[t].location)<(e=i[e].location)?-1:1});break;case"duration":o=n.sort(function(t,e){return(t=i[t].duration)-(e=i[e].duration)});break;case"length":o=n.sort(function(t,e){return(t=i[t].distance)-(e=i[e].distance)});break;case"rain":o=n.map(function(t){return i[t].rain?t:null});break;case"fireban":o=n.map(function(t){return i[t].fireban?t:null});break;default:o=n}return o},this.onSearchFocus=function(t,e){window.localStorage.setItem("id",null),window.localStorage.setItem("mode",null)},this.onSearchReset=function(t,e){t.offsetWidth-e.layerX<32&&(e.preventDefault(),t.blur(),t.value="",this.searchFor="",this.update())},this.onSearchSubmitted=function(t,e){e.preventDefault(),this.searchFor=t.value.trim(),this.update(),t.blur()},this.onSearchChanged=function(t,e){var i=this;clearTimeout(i.searchDelay),this.searchDelay=setTimeout(function(){i.searchFor=t.value.trim(),i.update()},700)},this.onSortingFocus=function(t,e){window.localStorage.setItem("id",null),window.localStorage.setItem("mode",null)},this.onSortingSelected=function(t,e){this.sortBy=t.value,this.update()},this.onMenuClicked=function(t){t.preventDefault();for(var e,i=t.target||t.srcElement;!e;)e=i.getAttribute("data-id"),i=i.parentNode;this.parent.update(e,"map")},t&&this.init()},SydneyTrainWalks.prototype.Overview=function(t){this.parent=t,this.config=t.config,this.overviewMap=null,this.awaitTimeout=null,this.config.extend=function(t){for(var e in t)this[e]=t[e]},this.config.extend({overview:document.querySelector(".localmap.overview"),creditTemplate:document.getElementById("credit-template")}),this.init=function(){var t=this.awaitView.bind(this);new MutationObserver(t).observe(document.body,{attributes:!0,attributeFilter:["id","class","style"],subtree:!0}),this.awaitView()},this.awaitView=function(t,e){var i=this.config.overview,n=this.createMap.bind(this);clearTimeout(this.awaitTimeout),this.awaitTimeout=setTimeout(function(){0<i.getBoundingClientRect().right&&(n(),e&&e.disconnect())},100)},this.createMap=function(){new Localmap({key:"_index",container:this.config.overview,legend:null,thumbsUrl:null,photosUrl:null,markersUrl:this.config.local+"/img/marker-{type}.svg",exifUrl:null,guideUrl:null,routeUrl:null,mapUrl:this.config.local+"/maps/{key}.jpg",tilesUrl:this.config.local+"/tiles/{z}/{x}/{y}.jpg",tilesZoom:11,guideData:this.processMarkers(),routeData:this.mergeRoutes(),exifData:null,creditsTemplate:this.config.creditTemplate.innerHTML})},this.processMarkers=function(){var e=this;return GuideData._index.markers.map(function(t){t.description="",t.callback=e.onMarkerClicked.bind(e,t.id)}),GuideData},this.mergeRoutes=function(){var t={_index:{features:[]}};if("undefined"!=typeof GpxData)for(var e in GpxData)GuideData[e].alias||(t._index.features=t._index.features.concat(GpxData[e].features));return t},this.onMarkerClicked=function(t,e){this.parent.update(t,"map")},t&&this.init()};var Filters=function(t){this.element=null,this.promise=null,this.input=null,this.select=null,this.delay=null,this.init=function(t){return this.element=t.element,this.promise=t.promise||function(){},this.input=this.element.getElementsByTagName("input")[0],this.select=this.element.getElementsByTagName("select")[0],this.sorters=this.select.getElementsByTagName("option"),this.input.addEventListener("blur",this.onSearchChanged()),this.input.addEventListener("keyup",this.onSearchChanged()),this.input.addEventListener("change",this.onSearchChanged()),this.select.addEventListener("change",this.onSorterSelected()),this.element.addEventListener("submit",this.onSearchSubmit()),/MSIE/i.test(navigator.userAgent)?this.input.style.backgroundImage="none":this.input.addEventListener("click",this.onSearchReset()),this},this.redraw=function(t){this.select.selectedIndex=t},this.searchFor=function(t){var e,i,n,o=document.querySelectorAll(this.element.getAttribute("data-target")),s=new RegExp("<[^>]*>","g"),a=new RegExp(t,"i");for(e=0,i=o.length;e<i;e+=1)n=o[e].innerHTML.replace(s," "),o[e].style.display=a.test(n)?"block":"none";this.promise()},this.sortBy=function(t){var e,i,n,o=[],s=this.sorters[t].getAttribute("data-source"),a=this.sorters[t].getAttribute("data-type"),r=document.querySelectorAll(this.element.getAttribute("data-target")),h=r[0].parentNode,c=document.createDocumentFragment();for(e=0,i=r.length;e<i;e+=1)o.push(r[e]);for(e=0,i=(n=o.sort(function(t,e){return t=t.querySelector(s).innerHTML,e=e.querySelector(s).innerHTML,"number"===a&&(t=parseFloat(t),e=parseFloat(e)),t<e?-1:1})).length;e<i;e+=1)c.appendChild(h.removeChild(n[e],!0));h.appendChild(c),this.redraw(t),this.promise()},this.onSearchSubmit=function(){var e=this;return function(t){t.preventDefault(),e.searchFor(e.input.value.trim()),e.input.blur()}},this.onSearchReset=function(){var e=this;return function(t){e.input.offsetWidth-t.layerX<32&&(t.preventDefault(),e.input.blur(),e.input.value="",e.searchFor(""))}},this.onSearchChanged=function(){var e=this;return function(t){clearTimeout(e.delay),e.delay=setTimeout(function(){e.searchFor(e.input.value.trim())},700)}},this.onSorterSelected=function(){var e=this;return function(t){t.preventDefault(),e.sortBy(e.select.selectedIndex)}},this.init(t)};"undefined"!=typeof define&&define([],function(){return Filters}),"undefined"!=typeof module&&(module.exports=Filters);var Localmap=function(t){for(var e in this.config={key:null,alias:null,container:null,canvasWrapper:null,canvasElement:null,thumbsUrl:null,photosUrl:null,markersUrl:null,guideUrl:null,routeUrl:null,mapUrl:null,tilesUrl:null,tilesZoom:15,exifUrl:null,guideData:null,routeData:null,exifData:null,creditsTemplate:null,useTransitions:null,minimum:{lon:null,lat:null,lon_cover:null,lat_cover:null,zoom:null},maximum:{lon:null,lat:null,lon_cover:null,lat_cover:null,zoom:null},position:{lon:null,lat:null,zoom:null},indicator:{icon:null,photo:null,description:null,lon:null,lat:null,zoom:null,referrer:null}},t)this.config[e]=t[e];this.update=function(){clearTimeout(this.saveTimeout),this.saveTimeout=window.setTimeout(this.store.bind(this),1e3),window.cancelAnimationFrame(this.animationFrame),this.animationFrame=window.requestAnimationFrame(this.redraw.bind(this))},this.redraw=function(){for(var t in this.components)this.components[t].update&&this.components[t].update(this.config)},this.focus=function(t,e,i,n){this.config.useTransitions=n,this.config.position.lon=Math.max(Math.min(t,this.config.maximum.lon_cover),this.config.minimum.lon_cover),this.config.position.lat=Math.min(Math.max(e,this.config.maximum.lat_cover),this.config.minimum.lat_cover),this.config.position.zoom=Math.max(Math.min(i,this.config.maximum.zoom),this.config.minimum.zoom),this.update()},this.store=function(){var t={};t[this.config.key]={lon:this.config.position.lon,lat:this.config.position.lat,zoom:this.config.position.zoom},localStorage.setItem("localmap",JSON.stringify(t))},this.restore=function(t,e,i){var n=JSON.parse(localStorage.getItem("localmap")),o=this.config.key;n&&n[o]?this.focus(n[o].lon,n[o].lat,n[o].zoom,!1):this.focus(t,e,i,!1)},this.describe=function(t){this.components.modal.show(t),t.callback&&t.callback(t)},this.stop=function(){for(var t in this.components)this.components[t].stop&&this.components[t].stop(this.config)},this.indicate=function(t){var e=this.components.canvas.components.indicator;return e.reset(),e.show(t),!1},this.unindicate=function(){return this.components.canvas.components.indicator.hide(),!1},this.onComplete=function(){this.config.container.className=this.config.container.className.replace(/ localmap-busy/g,"");var t=this.config.maximum,e=this.config.minimum;this.restore((t.lon_cover-e.lon_cover)/2+e.lon_cover,(t.lat_cover-e.lat_cover)/2+e.lat_cover,1.25*e.zoom)},this.config.container.className+=" localmap-busy",this.components={canvas:new this.Canvas(this,this.onComplete.bind(this),this.describe.bind(this),this.focus.bind(this)),controls:new this.Controls(this),scale:new this.Scale(this),credits:new this.Credits(this),modal:new this.Modal(this),legend:new this.Legend(this,this.indicate.bind(this))}};"undefined"!=typeof define&&define([],function(){return Localmap}),"undefined"!=typeof module&&(module.exports=Localmap),Localmap.prototype.Background=function(t,d){this.parent=t,this.config=t.config,this.element=null,this.image=new Image,this.tilesQueue=null,this.tilesSize=256;function l(t,e){return Math.floor((t+180)/360*Math.pow(2,e))}function u(t,e){return Math.floor((1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,e))}this.start=function(){this.element=document.createElement("div"),this.element.setAttribute("class","localmap-background"),this.parent.element.appendChild(this.element),this.parent.canvasElement=this.element,this.config.tilesUrl?this.loadTiles():this.loadBitmap(),window.addEventListener("resize",this.redraw.bind(this))},this.stop=function(){this.parent.element.removeChild(this.element)},this.update=function(){},this.redraw=function(){var t=this.config.container,e=this.element,i=this.config.minimum,n=this.config.maximum;i.zoom=Math.max(t.offsetWidth/e.offsetWidth,t.offsetHeight/e.offsetHeight),n.zoom=2},this.loadBitmap=function(){var t=this.config.alias||this.config.key;this.image.addEventListener("load",this.onBitmapLoaded.bind(this)),this.image.setAttribute("src",this.config.mapUrl.replace("{key}",t))},this.drawBitmap=function(){this.config.container;var t=this.element,e=this.image,i=this.config.minimum,n=this.config.maximum,o=e.naturalWidth/(n.lon-i.lon),s=e.naturalHeight/(n.lat-i.lat),a=(i.lon-i.lon_cover)*o,r=(i.lat-i.lat_cover)*s,h=(n.lon_cover-i.lon_cover)*o,c=(n.lat_cover-i.lat_cover)*s;t.style.width=h+"px",t.style.height=c+"px",e.style.marginLeft=a+"px",e.style.marginTop=r+"px",t.appendChild(e),this.redraw(),d()},this.measureTiles=function(){var t=this.config.minimum,e=this.config.maximum,i=this.config.position,n=l(t.lon_cover,this.config.tilesZoom),o=u(t.lat_cover,this.config.tilesZoom),s=l(e.lon_cover,this.config.tilesZoom),a=u(e.lat_cover,this.config.tilesZoom),r=JSON.parse(localStorage.getItem("localmap")),h=this.config.key;return r&&r[h]&&(i.lon=r[h].lon,i.lat=r[h].lat),{minX:n,minY:o,maxX:s,maxY:a,posX:l(i.lon,this.config.tilesZoom),posY:u(i.lat,this.config.tilesZoom)}},this.scoreMarkers=function(){for(var t,e,i,n,o,s,a=this.config.guideData[this.config.key].markers,r={},h=0,c=a.length;h<c;h+=1)n=(t=l(a[h].lon,this.config.tilesZoom))+1,o=1+(i=(e=u(a[h].lat,this.config.tilesZoom))-1),r[(s=t-1)+"_"+i]=-10,r[t+"_"+i]=-10,r[n+"_"+i]=-10,r[s+"_"+e]=-10,r[t+"_"+e]=-20,r[n+"_"+e]=-10,r[s+"_"+o]=-10,r[t+"_"+o]=-10,r[n+"_"+o]=-10;return r},this.loadTiles=function(){this.config.container;var t=this.element,e=this.measureTiles(),i=Math.max(e.maxX-e.minX,1),n=Math.max(e.maxY-e.minY,1),o=this.tilesSize,s=i*o,a=n*o,r=s/2,h=a/2;t.width=s,t.height=a,t.style.width=r+"px",t.style.height=h+"px",this.tilesQueue=[];for(var c=this.scoreMarkers(),l=e.minX;l<=e.maxX;l+=1)for(var u=e.minY;u<=e.maxY;u+=1)this.tilesQueue.push({url:this.config.tilesUrl.replace("{x}",l).replace("{y}",u).replace("{z}",this.config.tilesZoom),x:l-e.minX,y:u-e.minY,w:o,h:o,d:Math.abs(l-e.posX)+Math.abs(u-e.posY),r:c[l+"_"+u]||0});this.tilesQueue.sort(function(t,e){return e.d+e.r-(t.d+t.r)}),this.image=new Image,this.image.addEventListener("load",this.onTileLoaded.bind(this)),this.image.addEventListener("error",this.onTileError.bind(this)),this.image.setAttribute("src",this.tilesQueue[this.tilesQueue.length-1].url),this.redraw(),d()},this.drawTile=function(t){var e=this.tilesQueue.pop();if(t){var i=t.cloneNode();i.style.left=e.x*e.w/2+"px",i.style.top=e.y*e.h/2+"px",i.style.width=e.w/2+"px",i.style.height=e.h/2+"px",i.setAttribute("class","localmap-tile"),this.element.appendChild(i)}0<this.tilesQueue.length&&this.image.setAttribute("src",this.tilesQueue[this.tilesQueue.length-1].url)},this.onBitmapLoaded=function(t){this.drawBitmap()},this.onTileLoaded=function(t){this.drawTile(t.target)},this.onTileError=function(t){this.drawTile(null)},this.start()},Localmap.prototype.Canvas=function(t,e,i,n){this.parent=t,this.config=t.config,this.element=document.createElement("div"),this.config.canvasWrapper=this.element,this.start=function(){this.element.setAttribute("class","localmap-canvas"),this.element.addEventListener("transitionend",this.onUpdated.bind(this)),this.config.container.appendChild(this.element),this.addMarkers()},this.stop=function(){for(var t in this.components)this.components[t].stop&&this.components[t].stop(this.config);this.config.container.removeChild(this.element)},this.update=function(){for(var t in this.redraw(),this.components)this.components[t].update&&this.components[t].update(this.config)},this.redraw=function(){var t=this.config.container,e=this.element,i=this.config.minimum,n=this.config.maximum,o=this.config.position,s=(o.lon-i.lon_cover)/(n.lon_cover-i.lon_cover)*e.offsetWidth,a=(o.lat-i.lat_cover)/(n.lat_cover-i.lat_cover)*e.offsetHeight,r=Math.max(Math.min(o.zoom,n.zoom),i.zoom),h=-s*r+t.offsetWidth/2,c=-a*r+t.offsetHeight/2;h=Math.max(Math.min(h,0),t.offsetWidth-e.offsetWidth*r),c=Math.max(Math.min(c,0),t.offsetHeight-e.offsetHeight*r),this.config.useTransitions&&(this.element.className+=" localmap-canvas-transition"),e.style.transform="translate3d("+h+"px, "+c+"px, 0px) scale3d("+r+", "+r+",1)"},this.components={indicator:new t.Indicator(this,i,n),location:new t.Location(this)},this.addMarkers=function(){this.components.markers=new t.Markers(this,i,this.addBackground.bind(this))},this.addBackground=function(){this.components.background=new t.Background(this,this.addRoute.bind(this))},this.addRoute=function(){this.components.route=new t.Route(this,e)},this.onUpdated=function(t){this.element.className=this.element.className.replace(/ localmap-canvas-transition/g,"")},this.start()},Localmap.prototype.Controls=function(t){this.parent=t,this.config=t.config,this.touches=null,this.inertia={x:0,y:0,z:0},this.elements={},this.range={},this.steps={x:.03,y:.03,z:.03},this.zoom=null,this.last=null,this.start=function(){this.element=document.createElement("nav"),this.element.setAttribute("class","localmap-controls"),this.config.container.appendChild(this.element),this.elements.zoomin=document.createElement("button"),this.elements.zoomin.innerHTML="Zoom in",this.elements.zoomin.setAttribute("class","localmap-controls-zoomin"),this.elements.zoomin.addEventListener("click",this.buttonInteraction.bind(this,1.5)),this.element.appendChild(this.elements.zoomin),this.elements.zoomout=document.createElement("button"),this.elements.zoomout.innerHTML="Zoom out",this.elements.zoomout.setAttribute("class","localmap-controls-zoomout"),this.elements.zoomout.addEventListener("click",this.buttonInteraction.bind(this,.667)),this.element.appendChild(this.elements.zoomout)},this.stop=function(){this.config.container.removeChild(this.element)},this.update=function(){this.zoom!==this.config.position.zoom&&(this.elements.zoomin.disabled=this.config.position.zoom===this.config.maximum.zoom,this.elements.zoomout.disabled=this.config.position.zoom===this.config.minimum.zoom),this.zoom=this.config.position.zoom},this.reposition=function(t,e){if(window.cancelAnimationFrame(this.animationFrame),this.parent.focus(this.config.position.lon+this.range.lon*-this.inertia.x,this.config.position.lat+this.range.lat*-this.inertia.y,this.config.position.zoom+this.range.zoom*this.inertia.z,!1),t&&(.001<Math.abs(this.inertia.x)||.001<Math.abs(this.inertia.y)||.001<Math.abs(this.inertia.z))){var i="touch"==e?.7:.9;this.inertia.x*=i,this.inertia.y*=i,this.inertia.z=0,this.animationFrame=window.requestAnimationFrame(this.reposition.bind(this,t,e))}},this.startInteraction=function(t,e){this.inertia.x=0,this.inertia.y=0,this.inertia.z=0,this.range.lon=this.config.maximum.lon_cover-this.config.minimum.lon_cover,this.range.lat=this.config.maximum.lat_cover-this.config.minimum.lat_cover,this.range.zoom=this.config.maximum.zoom-this.config.minimum.zoom,this.range.x=this.config.canvasWrapper.offsetWidth*this.config.position.zoom,this.range.y=this.config.canvasWrapper.offsetHeight*this.config.position.zoom,this.touches=e.touches||[{clientX:e.clientX,clientY:e.clientY}]},this.moveInteraction=function(t,e){e.preventDefault();var i=e.touches||[{clientX:e.clientX,clientY:e.clientY}],n=this.touches;if(n){if(this.last=new Date-500,1<i.length&&1<n.length){var o=(Math.abs(i[0].clientX-i[1].clientX)-Math.abs(n[0].clientX-n[1].clientX))/this.config.container.offsetWidth,s=(Math.abs(i[0].clientY-i[1].clientY)-Math.abs(n[0].clientY-n[1].clientY))/this.config.container.offsetHeight;this.inertia.x=(i[0].clientX-n[0].clientX+(i[1].clientX-n[1].clientX))/2/this.range.x,this.inertia.y=(i[0].clientY-n[0].clientY+(i[1].clientY-n[1].clientY))/2/this.range.y,this.inertia.z=(o+s)/2}else this.inertia.x=(i[0].clientX-n[0].clientX)/this.range.x,this.inertia.y=(i[0].clientY-n[0].clientY)/this.range.y,this.inertia.z=0;this.inertia.x=Math.max(Math.min(this.inertia.x,this.steps.x),-this.steps.x),this.inertia.y=Math.max(Math.min(this.inertia.y,this.steps.y),-this.steps.y),this.inertia.z*=this.config.position.zoom,this.reposition(!1,t),this.touches=i}},this.endInteraction=function(t,e){this.touches=null,this.reposition(!0,t)},this.buttonInteraction=function(t,e){this.last=new Date-500,this.parent.focus(this.config.position.lon,this.config.position.lat,this.config.position.zoom*t,!0)},this.wheelInteraction=function(t,e){e.preventDefault(),this.range.lon=this.config.maximum.lon_cover-this.config.minimum.lon_cover,this.range.lat=this.config.maximum.lat_cover-this.config.minimum.lat_cover,this.range.zoom=this.config.maximum.zoom-this.config.minimum.zoom,this.inertia.z+=0<e.deltaY?this.steps.z:-this.steps.z,this.reposition(!0,t)},this.dblclickInteraction=function(t,e){new Date-this.last<250&&this.parent.focus(this.config.position.lon,this.config.position.lat,1.5*this.config.position.zoom,!0),this.last=new Date},this.cancelInteraction=function(t,e){console.log("cancelInteraction")},this.config.container.addEventListener("mousedown",this.startInteraction.bind(this,"mouse")),this.config.container.addEventListener("mousemove",this.moveInteraction.bind(this,"mouse")),this.config.container.addEventListener("mouseup",this.endInteraction.bind(this,"mouse")),this.config.container.addEventListener("wheel",this.wheelInteraction.bind(this,"mouse")),this.config.container.addEventListener("click",this.dblclickInteraction.bind(this,"mouse")),this.config.container.addEventListener("touchstart",this.startInteraction.bind(this,"touch")),this.config.container.addEventListener("touchmove",this.moveInteraction.bind(this,"touch")),this.config.container.addEventListener("touchend",this.endInteraction.bind(this,"touch")),this.config.container.addEventListener("touchcancel",this.cancelInteraction.bind(this,"touch")),this.start()},Localmap.prototype.Credits=function(t){this.parent=t,this.config=t.config,this.element=null,this.start=function(){this.element=document.createElement("figcaption"),this.element.setAttribute("class","localmap-credits"),this.element.innerHTML=this.config.creditsTemplate,this.config.container.appendChild(this.element)},this.stop=function(){this.config.container.removeChild(this.element)},this.update=function(){},this.start()},Localmap.prototype.Indicator=function(t,e,i){this.parent=t,this.config=t.config,this.element=new Image,this.zoom=null,this.lon=null,this.lat=null,this.start=function(){this.element.setAttribute("src",this.config.markersUrl.replace("{type}","focus")),this.element.setAttribute("alt",""),this.element.setAttribute("class","localmap-indicator"),this.element.addEventListener("click",this.onIndicatorClicked.bind(this)),this.parent.element.appendChild(this.element)},this.stop=function(){this.parent.element.removeChild(this.element)},this.update=function(){this.zoom!==this.config.position.zoom&&this.resize(),this.lon!==this.config.indicator.lon&&this.lat!==this.config.indicator.lat&&this.reposition(),this.zoom=this.config.position.zoom},this.show=function(i){i.target&&(i=i.target),i.getAttribute||(i.getAttribute=function(t){return i[t]}),i.setAttribute||(i.setAttribute=function(t,e){i[t]=e});var t=i.getAttribute("data-url")||i.getAttribute("src")||i.getAttribute("href")||i.getAttribute("photo"),e=i.getAttribute("data-title")||i.getAttribute("title")||i.getAttribute("description")||i.innerHTML,n=i.getAttribute("data-lon")||i.getAttribute("lon"),o=i.getAttribute("data-lat")||i.getAttribute("lat"),s=this.config.alias||this.config.key,a=t?t.split("/").pop():null,r=this.config.exifData&&this.config.exifData[s]?this.config.exifData[s][a]:{};if(this.config.indicator={photo:a,description:e,lon:n||r.lon,lat:o||r.lat,zoom:this.config.maximum.zoom,referrer:i.referrer||i},this.config.indicator.lon&&this.config.indicator.lat)this.onIndicateSuccess();else{var h=new XMLHttpRequest;h.addEventListener("load",this.onExifLoaded.bind(this)),h.open("GET",this.config.exifUrl.replace("{src}",t),!0),h.send()}},this.reset=function(){this.config.indicator.referrer&&this.config.indicator.referrer.setAttribute("data-localmap","passive"),this.config.indicator={icon:null,photo:null,description:null,lon:null,lat:null,zoom:null,origin:null}},this.hide=function(){this.reset(),i(this.config.position.lon,this.config.position.lat,.25*this.config.position.zoom,!0)},this.resize=function(){var t=1/this.config.position.zoom;this.element.style.transform="scale3d("+t+", "+t+", 1)"},this.reposition=function(){var t=this.config.minimum,e=this.config.maximum,i=this.config.indicator.lon,n=this.config.indicator.lat;i>t.lon_cover&&i<e.lon_cover&&n<t.lat_cover&&n>e.lat_cover?(this.lon=i,this.lat=n,this.element.style.cursor=this.config.indicator.description?"pointer":"default",this.element.style.display="block",this.element.style.left=(i-t.lon_cover)/(e.lon_cover-t.lon_cover)*100+"%",this.element.style.top=(n-t.lat_cover)/(e.lat_cover-t.lat_cover)*100+"%"):(this.lon=null,this.lat=null,this.element.style.display="none")},this.onExifLoaded=function(t){var e,i,n,o,s=JSON.parse(t.target.response);s&&s.GPS&&(e=parseInt(s.GPS.GPSLongitude[0]),i=parseInt(s.GPS.GPSLongitude[1]),n=parseInt(s.GPS.GPSLongitude[2])/100,o=s.GPS.GPSLongitudeRef,this.config.indicator.lon=(e+i/60+n/3600)*("W"===o?-1:1),e=parseInt(s.GPS.GPSLatitude[0]),i=parseInt(s.GPS.GPSLatitude[1]),n=parseInt(s.GPS.GPSLatitude[2])/100,o=s.GPS.GPSLatitudeRef,this.config.indicator.lat=(e+i/60+n/3600)*("N"===o?1:-1),this.onIndicateSuccess())},this.onIndicateSuccess=function(){this.config.indicator.referrer.setAttribute("data-localmap","active"),i(this.config.indicator.lon,this.config.indicator.lat,this.config.indicator.zoom,!0)},this.onIndicatorClicked=function(t){t.preventDefault(),e(this.config.indicator)},this.start()},Localmap.prototype.Legend=function(t,a){this.parent=t,this.config=t.config,this.elements=[],this.start=function(){},this.stop=function(){this.config.legend&&(this.config.legend.innerHTML="")},this.update=function(){var t=this.config.key,e=this.config.guideData[t];this.config.legend&&0===this.elements.length&&(this.elements=e.markers.map(this.addDefinition.bind(this)))},this.addDefinition=function(t){var e={};if(t.description){var i=this.config.alias||this.config.key,n=t.photo?this.config.thumbsUrl.replace("{key}",i)+t.photo:this.config.markersUrl.replace("{type}",t.type),o=t.description||t.type,s=document.createDocumentFragment();e.title=document.createElement("dt"),e.title.className+=t.photo?" localmap-legend-photo":" localmap-legend-icon",e.title.innerHTML='<img alt="'+t.type+'" src="'+n+'"/>',e.title.style.backgroundImage='url("'+n+'")',s.appendChild(e.title),e.description=document.createElement("dd"),e.description.className+=t.optional||t.detour||t.warning?" localmap-legend-alternate":"",e.description.innerHTML="<p>"+o+"</p>",s.appendChild(e.description),t.referrer=e.title,e.title.addEventListener("click",a.bind(this,t)),e.description.addEventListener("click",a.bind(this,t)),this.config.legend.appendChild(s)}return e},this.start()},Localmap.prototype.Location=function(t){this.parent=t,this.config=t.config,this.element=new Image,this.zoom=null,this.active=!1,this.options={enableHighAccuracy:!0},this.start=function(){"geolocation"in navigator&&(this.permissions=document.createElement("nav"),this.permissions.setAttribute("class","localmap-permissions"),this.button=document.createElement("button"),this.button.setAttribute("title","Allow geolocation"),this.button.innerHTML="Allow geolocation",this.button.setAttribute("class","localmap-permissions-location"),this.permissions.appendChild(this.button),this.config.container.appendChild(this.permissions),this.button.addEventListener("click",this.requestPosition.bind(this)),this.config.container.addEventListener("mouseup",this.requestPosition.bind(this)),this.config.container.addEventListener("touchend",this.requestPosition.bind(this)),this.requestPosition())},this.stop=function(){this.config.container.removeChild(this.permissions)},this.update=function(){this.zoom!==this.config.position.zoom&&this.resize(),this.zoom=this.config.position.zoom},this.resize=function(){var t=1/this.config.position.zoom;this.element.style.transform="scale3d("+t+", "+t+", 1)"},this.requestPosition=function(){this.active||(this.locator=navigator.geolocation.watchPosition(this.onReposition.bind(this),this.onPositionFailed.bind(this),this.options),this.element.setAttribute("src",this.config.markersUrl.replace("{type}","location")),this.element.setAttribute("alt",""),this.element.setAttribute("class","localmap-location"),this.parent.element.appendChild(this.element),this.button.style.display="none")},this.onReposition=function(t){var e=this.config.minimum,i=this.config.maximum,n=t.coords.longitude,o=t.coords.latitude;n>e.lon_cover&&n<i.lon_cover&&o<e.lat_cover&&o>i.lat_cover?(this.element.style.display="block",this.element.style.left=(n-e.lon_cover)/(i.lon_cover-e.lon_cover)*100+"%",this.element.style.top=(o-e.lat_cover)/(i.lat_cover-e.lat_cover)*100+"%"):this.element.style.display="none"},this.onPositionFailed=function(t){console.log("requestPosition:",t)},this.start()},Localmap.prototype.Markers=function(t,e,a){this.parent=t,this.config=t.config,this.elements=[],this.zoom=null,this.delay=null,this.start=function(){var t=this.config.key;if(this.config.guideData&&this.config.guideData[t])this.addGuide();else{var e=new XMLHttpRequest;e.addEventListener("load",this.onGuideLoaded.bind(this)),e.open("GET",this.config.guideUrl.replace("{key}",this.config.key),!0),e.send()}},this.stop=function(){},this.update=function(){this.config.position.zoom!==this.zoom&&(clearTimeout(this.delay),this.delay=setTimeout(this.redraw.bind(this),100)),this.zoom=this.config.position.zoom},this.redraw=function(){var t=1/this.config.position.zoom;for(var e in this.elements)this.elements[e].style.transform="scale3d("+t+", "+t+", 1)"},this.addGuide=function(){var t=this.config,e=this.config.key,i=this.config.guideData[e];t.alias=i.alias?i.alias.key:i.key;var n=t.minimum,o=t.maximum;n.lon=i.alias?i.alias.bounds.west:i.bounds.west,n.lat=i.alias?i.alias.bounds.north:i.bounds.north,o.lon=i.alias?i.alias.bounds.east:i.bounds.east,o.lat=i.alias?i.alias.bounds.south:i.bounds.south,n.lon_cover=i.bounds.west,n.lat_cover=i.bounds.north,o.lon_cover=i.bounds.east,o.lat_cover=i.bounds.south;var s=t.position;s.lon=(o.lon_cover-n.lon_cover)/2+n.lon_cover,s.lat=(o.lat_cover-n.lat_cover)/2+n.lat_cover,i.markers.map(this.addMarker.bind(this)),a()},this.addMarker=function(t){t.element=t.photo?this.addLandmark(t):this.addWaypoint(t),t.element.addEventListener("click",e.bind(this,t)),this.parent.element.appendChild(t.element),this.elements.push(t.element)},this.addLandmark=function(t){var e=this.config.minimum,i=this.config.maximum,n=document.createElement("span");return n.setAttribute("class","localmap-waypoint"),n.style.left=(t.lon-e.lon_cover)/(i.lon_cover-e.lon_cover)*100+"%",n.style.top=(t.lat-e.lat_cover)/(i.lat_cover-e.lat_cover)*100+"%",n.style.cursor="pointer",n},this.addWaypoint=function(t){var e=this.config.minimum,i=this.config.maximum,n=new Image;return n.setAttribute("src",this.config.markersUrl.replace("{type}",t.type)),n.setAttribute("title",t.description||""),n.setAttribute("class","localmap-marker"),n.style.left=(t.lon-e.lon_cover)/(i.lon_cover-e.lon_cover)*100+"%",n.style.top=(t.lat-e.lat_cover)/(i.lat_cover-e.lat_cover)*100+"%",n.style.cursor=t.description||t.callback?"pointer":null,n},this.onGuideLoaded=function(t){this.config.guideData=this.config.guideData||{},this.config.guideData[this.config.key]=JSON.parse(t.target.response),this.addGuide()},this.start()},Localmap.prototype.Modal=function(t){this.parent=t,this.config=t.config,this.element=null,this.start=function(){this.element=document.createElement("section"),this.element.setAttribute("class","localmap-modal localmap-modal-hidden"),this.photo=document.createElement("figure"),this.photo.setAttribute("class","localmap-modal-photo"),this.element.appendChild(this.photo),this.description=document.createElement("article"),this.description.setAttribute("class","localmap-modal-content"),this.element.appendChild(this.description),this.closer=document.createElement("button"),this.closer.setAttribute("class","localmap-modal-closer"),this.closer.innerHTML="Close",this.closer.addEventListener("click",this.onDismiss.bind(this)),this.element.appendChild(this.closer),this.config.container.appendChild(this.element)},this.stop=function(){this.config.container.removeChild(this.element)},this.update=function(){},this.show=function(t){var e=this.config.alias||this.config.key;if(t.photo?(this.photo.style.backgroundImage="url("+this.config.photosUrl.replace("{key}",e)+t.photo+"), url("+this.config.thumbsUrl.replace("{key}",e)+t.photo+")",this.photo.className="localmap-modal-photo"):(this.photo.style.backgroundImage="url("+this.config.markersUrl.replace("{type}",t.type)+")",this.photo.className="localmap-modal-icon"),!t.description)return!1;this.description.innerHTML="<p>"+t.description+"</p>",this.element.className=this.element.className.replace(/-hidden/g,"-visible")},this.onDismiss=function(t){t.preventDefault(),this.element.className=this.element.className.replace(/-visible/g,"-hidden")},this.start()},Localmap.prototype.Route=function(t,a){this.parent=t,this.config=t.config,this.element=null,this.coordinates=[],this.zoom=null,this.delay=null,this.start=function(){var t=this.config.key;if(this.element=document.createElement("canvas"),this.element.setAttribute("class","localmap-route"),this.parent.element.appendChild(this.element),this.config.routeData&&this.config.routeData[t])this.onJsonLoaded(this.config.routeData[t]);else{var e=new XMLHttpRequest;e.addEventListener("load",this.onGpxLoaded.bind(this)),e.open("GET",this.config.routeUrl.replace("{key}",t),!0),e.send()}},this.stop=function(){this.parent.element.removeChild(this.element)},this.update=function(){this.config.position.zoom!==this.zoom&&(clearTimeout(this.delay),this.delay=setTimeout(this.redraw.bind(this),100)),this.zoom=this.config.position.zoom},this.redraw=function(){var t=this.config.minimum,e=this.config.maximum;this.element.width=this.parent.element.offsetWidth,this.element.height=this.parent.element.offsetHeight;var i,n,o,s,a=this.element.getContext("2d"),r=this.config.position.zoom,h=this.element.width,c=this.element.height;for(var l in a.clearRect(0,0,h,c),a.lineWidth=4/r,a.strokeStyle="orange",a.beginPath(),this.coordinates)this.coordinates.hasOwnProperty(l)&&l%1==0&&(o=parseInt((this.coordinates[l][0]-t.lon_cover)/(e.lon_cover-t.lon_cover)*h),s=parseInt((this.coordinates[l][1]-t.lat_cover)/(e.lat_cover-t.lat_cover)*c),Math.abs(o-i)+Math.abs(s-n)<30?a.lineTo(o,s):a.moveTo(o,s),i=o,n=s);a.stroke()},this.onJsonLoaded=function(t){for(var e,i=t.features,n=[],o=0,s=i.length;o<s;o+=1)e=i[o].geometry.coordinates[0][0]instanceof Array?[].concat.apply([],i[o].geometry.coordinates):i[o].geometry.coordinates,n.push(e);this.coordinates=[].concat.apply([],n),this.redraw(),a()},this.onGpxLoaded=function(t){var e=t.target.responseXML.querySelectorAll("trkpt,rtept");for(var i in e)e.hasOwnProperty(i)&&i%1==0&&this.coordinates.push([parseFloat(e[i].getAttribute("lon")),parseFloat(e[i].getAttribute("lat")),null]);this.redraw(),a()},this.start()},Localmap.prototype.Scale=function(t){this.parent=t,this.config=t.config,this.element=document.createElement("div"),this.zoom=null,this.delay=null,this.start=function(){this.element.setAttribute("class","localmap-scale"),this.config.container.appendChild(this.element)},this.stop=function(){this.config.container.removeChild(this.element)},this.update=function(){this.config.position.zoom!==this.zoom&&(clearTimeout(this.delay),this.delay=setTimeout(this.redraw.bind(this),10)),this.zoom=this.config.position.zoom},this.redraw=function(){var t=this.distance({lon:this.config.minimum.lon_cover,lat:this.config.maximum.lat_cover},{lon:this.config.maximum.lon_cover,lat:this.config.maximum.lat_cover}),e=this.config.container.offsetWidth/this.config.canvasWrapper.offsetWidth/this.config.position.zoom,i=e*t/6,n=100,o="100km";i<50&&(n=50,o="50km"),i<20&&(n=20,o="20km"),i<10&&(n=10,o="10km"),i<5&&(n=5,o="5km"),i<2&&(n=2,o="2km"),i<1&&(n=1,o="1km"),i<.5&&(n=.5,o="500m"),i<.2&&(n=.2,o="200m"),i<.1&&(n=.1,o="100m"),this.element.style.width=n/e/t*100+"%",this.element.innerHTML=o},this.distance=function(t,e){var i=Math.PI*t.lon/180,n=Math.PI*e.lon/180,o=Math.PI*t.lat/180,s=Math.PI*e.lat/180,a=(i-n)*Math.cos((o+s)/2),r=o-s;return 6371*Math.sqrt(a*a+r*r)},this.start()};var Photocylinder=function(t){return this.only=function(t){return new this.Main(t,this).init()},this.each=function(t){for(var e,i=[],n=0,o=t.elements.length;n<o;n+=1)(e=Object.create(t)).element=t.elements[n],i[n]=new this.Main(e,this);return i},t.elements?this.each(t):this.only(t)};"undefined"!=typeof define&&define([],function(){return Photocylinder}),"undefined"!=typeof module&&(module.exports=Photocylinder),Photocylinder.prototype.Busy=function(t){this.container=t,this.show=function(){this.spinner=document.createElement("div"),this.spinner.className=this.container===document.body?"photocylinder-busy photocylinder-busy-fixed photocylinder-busy-active":"photocylinder-busy photocylinder-busy-active",this.container.appendChild(this.spinner)},this.hide=function(){this.spinner&&this.spinner.parentNode&&(this.spinner.parentNode.removeChild(this.spinner),this.spinner=null)}},Photocylinder.prototype.Fallback=function(t){this.parent=t,this.config=t.config,this.popup=this.config.popup,this.image=this.config.image,this.imageAspect=null,this.wrapper=null,this.wrapperAspect=null,this.fov=null,this.magnification={},this.horizontal={},this.vertical={},this.tracked=null,this.increment=this.config.idle/200,this.auto=!0,this.init=function(){this.build(),this.render(),this.controls(),this.resizeListener=this.resize.bind(this),window.addEventListener("resize",this.resizeListener,!0)},this.destroy=function(){window.removeEventListener("resize",this.resizeListener,!0),window.removeEventListener("deviceorientation",this.tiltListener,!0)},this.build=function(){this.wrapper=document.createElement("div"),this.wrapper.setAttribute("class","photo-cylinder pc-fallback");this.image.cloneNode(!0);this.wrapper.appendChild(this.image),this.popup.appendChild(this.wrapper)},this.render=function(){this.imageAspect=this.image.offsetWidth/this.image.offsetHeight,this.magnification.min=1,this.magnification.max=4,this.recentre(),this.resize(),1<=this.imageAspect-this.wrapperAspect&&this.animate()},this.controls=function(){this.wrapper.addEventListener("touchstart",this.touch.bind(this,"start")),this.wrapper.addEventListener("touchmove",this.touch.bind(this,"move")),this.wrapper.addEventListener("touchend",this.touch.bind(this,"end")),this.wrapper.addEventListener("mousedown",this.touch.bind(this,"start")),this.wrapper.addEventListener("mousemove",this.touch.bind(this,"move")),this.wrapper.addEventListener("mouseup",this.touch.bind(this,"end")),this.wrapper.addEventListener("mousewheel",this.wheel.bind(this)),this.wrapper.addEventListener("DOMMouseScroll",this.wheel.bind(this)),this.tiltListener=this.tilt.bind(this),window.addEventListener("deviceorientation",this.tiltListener,!0)},this.coords=function(t){return{x:t.screenX||t.touches[0].screenX,y:t.screenY||t.touches[0].screenY,z:t.touches&&1<t.touches.length?Math.abs(t.touches[0].screenX-t.touches[1].screenX+t.touches[0].screenY-t.touches[1].screenY):0}},this.recentre=function(){this.magnification.current=1.25*this.magnification.min,this.horizontal.current=.5,this.vertical.current=.5},this.magnify=function(t){this.magnification.current=Math.max(Math.min(t,this.magnification.max),this.magnification.min),this.horizontal.min=Math.min(.5-(this.magnification.current-this.wrapperAspect/this.imageAspect)/2,.5),this.horizontal.max=Math.max(1-this.horizontal.min,.5),this.horizontal.current=Math.max(Math.min(this.horizontal.current,this.horizontal.max),this.horizontal.min),this.vertical.min=Math.min(.5-(this.magnification.current-1)/2,.5),this.vertical.max=Math.max(1-this.vertical.min,.5),this.vertical.current=Math.max(Math.min(this.vertical.current,this.vertical.max),this.vertical.min),this.redraw()},this.move=function(t,e){this.horizontal.current=Math.max(Math.min(t,this.horizontal.max),this.horizontal.min),this.vertical.current=Math.max(Math.min(e,this.vertical.max),this.vertical.min),this.redraw()},this.momentum=function(){(this.magnification.delta||this.horizontal.delta||this.vertical.delta)&&(this.magnification.delta=1e-4<Math.abs(this.magnification.delta)?this.magnification.delta/1.05:0,this.horizontal.delta=.001<Math.abs(this.horizontal.delta)?this.horizontal.delta/1.05:0,this.vertical.delta=.001<Math.abs(this.vertical.delta)?this.vertical.delta/1.05:0,this.move(this.horizontal.current+this.horizontal.delta,this.vertical.current+this.vertical.delta),this.magnify(this.magnification.current+this.magnification.delta),window.requestAnimationFrame(this.momentum.bind(this)))},this.redraw=function(){this.image.style.transform="translate("+-100*this.horizontal.current+"%, "+-100*this.vertical.current+"%) scale("+this.magnification.current+", "+this.magnification.current+")"},this.animate=function(t){if("boolean"==typeof t&&(this.auto=t),this.auto){this.horizontal.current+2*this.increment>this.horizontal.max&&(this.increment=-this.config.idle/200),this.horizontal.current+2*this.increment<this.horizontal.min&&(this.increment=this.config.idle/200);var e=this.horizontal.current+this.increment;this.move(e,this.vertical.current),window.requestAnimationFrame(this.animate.bind(this))}},this.tilt=function(t){this.auto=!1,this.horizontal.tilted&&this.vertical.tilted&&Math.abs(t.alpha-this.horizontal.tilted)<45&&Math.abs(t.beta-this.vertical.tilted)<45&&this.move(this.horizontal.current-(t.alpha-this.horizontal.tilted)/180,this.vertical.current-(t.beta-this.vertical.tilted)/180),this.horizontal.tilted=t.alpha,this.vertical.tilted=t.beta},this.wheel=function(t){t.preventDefault(),this.auto=!1,this.magnification.delta=0;this.coords(t);var e=t.deltaY||t.wheelDeltaY||t.wheelDelta;this.magnification.delta=e/this.wrapper.offsetHeight,this.magnify(this.magnification.current+this.magnification.delta),this.momentum()},this.touch=function(t,e){e.preventDefault();var i,n=this.magnification.current/this.magnification.min;switch(t){case"start":this.auto=!1,this.magnification.delta=0,this.horizontal.delta=0,this.vertical.delta=0,this.tracked=this.coords(e);break;case"move":this.tracked&&(i=this.coords(e),this.magnification.delta=(this.tracked.z-i.z)/this.wrapper.offsetWidth*n*2,this.horizontal.delta=(this.tracked.x-i.x)/this.wrapper.offsetWidth*n/this.imageAspect,this.vertical.delta=(this.tracked.y-i.y)/this.wrapper.offsetHeight*n,this.move(this.horizontal.current+this.horizontal.delta,this.vertical.current+this.vertical.delta),this.magnify(this.magnification.current-this.magnification.delta),this.tracked.x=i.x,this.tracked.y=i.y,this.tracked.z=i.z);break;case"end":this.tracked=null,this.momentum()}},this.resize=function(){this.wrapperAspect=this.wrapper.offsetWidth/this.wrapper.offsetHeight;var t=this.magnification.current||1,e=this.horizontal.current||.5,i=this.vertical.current||.5;this.magnify(t),this.move(e,i)}},Photocylinder.prototype.Main=function(t,e){for(var i in this.context=e,this.element=t.element,this.config={container:document.body,spherical:/r(\d+).jpg/i,standalone:!1,slicer:"{src}",idle:.1},t)this.config[i]=t[i];this.success=function(t,e){console.log("success",t);var i=this.config;this.busy.hide();var n=i.image,o=n.naturalWidth&&n.naturalHeight&&3<n.naturalWidth/n.naturalHeight;i.standalone?(i.popup=i.container,i.popup.innerHTML=""):(this.popup=new this.context.Popup(this),this.popup.show()),this.stage=/msie|trident|edge/i.test(navigator.userAgent)||!this.config.spherical.test(t)&&!o?new this.context.Fallback(this):new this.context.Stage(this),this.stage.init(),i.success&&i.success(i.popup)},this.failure=function(t,e){var i=this.config;this.config.image=null,this.popup&&(i.popup.parentNode.removeChild(i.popup),this.popup=null),this.stage&&(this.stage.destroy(),i.stage.parentNode.removeChild(i.stage),this.stage=null),i.failure&&i.failure(i.popup),this.busy.hide()},this.destroy=function(){this.stage.destroy()},this.onElementClicked=function(t){t&&t.preventDefault(),this.busy=new this.context.Busy(this.config.container),this.busy.show();var e=this.config.url||this.element.getAttribute("href")||this.element.getAttribute("data-url"),i=this.config.spherical.test(e)?"height=1080&top=0.2&bottom=0.8":"height=1080";this.config.image=new Image,this.config.image.src=this.config.slicer.replace("{src}",e).replace("{size}",i),this.config.image.addEventListener("load",this.success.bind(this,e)),this.config.image.addEventListener("error",this.failure.bind(this,e))},this.config.element&&this.config.element.addEventListener("click",this.onElementClicked.bind(this)),this.config.url&&this.onElementClicked()},Photocylinder.prototype.Popup=function(t){this.parent=t,this.config=t.config,this.show=function(){var t=this.config;t.popup||(t.popup=document.createElement("figure"),t.popup.className=t.container===document.body?"photocylinder-popup photocylinder-popup-fixed photocylinder-popup-passive":"photocylinder-popup photocylinder-popup-passive",this.addCloser(),this.addLocator(),t.container.appendChild(t.popup),setTimeout(this.onShow.bind(this),0))},this.hide=function(){var t=this.config;if(t.popup){t.popup.className=t.popup.className.replace(/-active/gi,"-passive");var e=this;setTimeout(function(){t.container.removeChild(t.popup),t.popup=null,e.parent.destroy()},500)}},this.addCloser=function(){var t=this.config,e=document.createElement("a");e.className="photocylinder-closer",e.innerHTML="x",e.href="#close",e.addEventListener("click",this.onHide.bind(this)),e.addEventListener("touchstart",this.onHide.bind(this)),t.popup.appendChild(e)},this.addLocator=function(t){var e=this.config;if(e.located){var i=document.createElement("a");i.className="photocylinder-locator",i.innerHTML="Show on a map",i.href="#map",i.addEventListener("click",this.onLocate.bind(this)),i.addEventListener("touchstart",this.onLocate.bind(this)),e.popup.appendChild(i)}},this.onShow=function(){var t=this.config;t.popup.className=t.popup.className.replace(/-passive/gi,"-active"),t.opened&&t.opened(t.element)},this.onHide=function(t){var e=this.config;t.preventDefault(),this.hide(),e.closed&&e.closed(e.element)},this.onLocate=function(t){var e=this.config;t.preventDefault(),e.located&&e.located(e.element)}},Photocylinder.prototype.Stage=function(t){this.parent=t,this.config=t.config,this.popup=this.config.popup,this.image=this.config.image,this.imageAspect=null,this.wrapper=null,this.wrapperAspect=null,this.baseAngle=60,this.baseSize=500,this.obj=null,this.objRow=null,this.objCols=[],this.fov=null,this.magnification={},this.rotation={},this.offset={},this.tracked=null,this.increment=this.config.idle,this.auto=!0,this.init=function(){this.build(),this.render(),this.controls(),this.resizeListener=this.resize.bind(this),window.addEventListener("resize",this.resizeListener,!0)},this.destroy=function(){window.removeEventListener("resize",this.resizeListener,!0),window.removeEventListener("deviceorientation",this.tiltListener,!0)},this.build=function(){this.wrapper=document.createElement("div"),this.wrapper.setAttribute("class","photo-cylinder"),this.objRow=document.createElement("div"),this.objRow.setAttribute("class","pc-obj-row"),this.wrapper.appendChild(this.objRow);for(var t=0;t<8;t+=1)this.objCols[t]=document.createElement("span"),this.objCols[t].setAttribute("class","pc-obj-col pc-obj-col-"+t),this.objRow.appendChild(this.objCols[t]);this.wrapper.appendChild(this.image),this.popup.appendChild(this.wrapper),this.config.stage=this.wrapper},this.render=function(){var t=this.image.getAttribute("src");this.fov=this.config.spherical.test(t)?360:180,this.imageAspect=this.image.offsetWidth/this.image.offsetHeight,this.wrapper.className+=this.fov<360?" pc-180":" pc-360",this.magnification.min=Math.max(this.imageAspect*(360/this.fov)*.3,1),this.magnification.max=4,this.magnification.current=1.25*this.magnification.min,this.offset.min=0;for(var e=this.offset.max=0,i=this.objCols.length;e<i;e+=1)this.objCols[e].style.backgroundImage="url('"+t+"')";this.resize(),this.recentre(),this.animate()},this.controls=function(){this.wrapper.addEventListener("touchstart",this.touch.bind(this,"start")),this.wrapper.addEventListener("touchmove",this.touch.bind(this,"move")),this.wrapper.addEventListener("touchend",this.touch.bind(this,"end")),this.wrapper.addEventListener("mousedown",this.touch.bind(this,"start")),this.wrapper.addEventListener("mousemove",this.touch.bind(this,"move")),this.wrapper.addEventListener("mouseup",this.touch.bind(this,"end")),this.wrapper.addEventListener("mousewheel",this.wheel.bind(this)),this.wrapper.addEventListener("DOMMouseScroll",this.wheel.bind(this)),this.tiltListener=this.tilt.bind(this),window.addEventListener("deviceorientation",this.tiltListener,!0)},this.coords=function(t){return{x:t.screenX||t.touches[0].screenX,y:t.screenY||t.touches[0].screenY,z:t.touches&&1<t.touches.length?Math.abs(t.touches[0].screenX-t.touches[1].screenX+t.touches[0].screenY-t.touches[1].screenY):0}},this.recentre=function(){this.rotate(this.fov/2)},this.magnify=function(t,e){this.magnification.current=Math.max(Math.min(t,this.magnification.max),this.magnification.min),this.baseAngle=60*this.wrapperAspect*(this.magnification.min/this.magnification.current),this.offset.max=(this.magnification.current-this.magnification.min)/8,this.offset.min=-1*this.offset.max,this.offset.current=Math.max(Math.min(e,this.offset.max),this.offset.min);var i=(this.baseAngle-360/this.objCols.length)/2;this.rotation.min=this.fov<360?i:0,this.rotation.max=this.fov<360?this.fov-this.baseAngle+i:this.fov,this.redraw()},this.rotate=function(t){this.rotation.current=this.fov<360?Math.max(Math.min(t,this.rotation.max),this.rotation.min):t%360,this.redraw()},this.momentum=function(){(this.rotation.delta||this.magnification.delta||this.offset.delta)&&(this.rotation.delta=.1<Math.abs(this.rotation.delta)?this.rotation.delta/1.05:0,this.magnification.delta=1e-4<Math.abs(this.magnification.delta)?this.magnification.delta/1.05:0,this.offset.delta=.001<Math.abs(this.offset.delta)?this.offset.delta/1.05:0,this.rotate(this.rotation.current+this.rotation.delta),this.magnify(this.magnification.current+this.magnification.delta,this.offset.current+this.offset.delta),window.requestAnimationFrame(this.momentum.bind(this)))},this.redraw=function(){var t=this.wrapper.offsetHeight/this.baseSize;this.objRow.style.transform="translate(-50%, "+-100*(.5+this.offset.current*t)+"%) scale("+this.magnification.current*t+") rotateY("+this.rotation.current+"deg)"},this.animate=function(t){if("boolean"==typeof t&&(this.auto=t),this.auto){this.rotation.current+2*this.increment>this.rotation.max&&(this.increment=-this.config.idle),this.rotation.current+2*this.increment<this.rotation.min&&(this.increment=this.config.idle);var e=this.fov<360?this.rotation.current+this.increment:(this.rotation.current+this.increment)%360;this.rotate(e),window.requestAnimationFrame(this.animate.bind(this))}},this.tilt=function(t){this.auto=!1,this.rotation.tilted&&Math.abs(t.alpha-this.rotation.tilted)<45&&this.rotate(this.rotation.current+t.alpha-this.rotation.tilted),this.rotation.tilted=t.alpha},this.wheel=function(t){t.preventDefault(),this.auto=!1,this.magnification.delta=0;this.coords(t);var e=t.deltaY||t.wheelDeltaY||t.wheelDelta;this.magnification.delta=e/this.wrapper.offsetHeight,this.magnify(this.magnification.current+this.magnification.delta,this.offset.current),this.momentum()},this.touch=function(t,e){e.preventDefault();var i,n=this.magnification.current/this.magnification.min;switch(t){case"start":this.auto=!1,this.rotation.delta=0,this.magnification.delta=0,this.offset.delta=0,this.tracked=this.coords(e);break;case"move":this.tracked&&(i=this.coords(e),this.rotation.delta=this.baseAngle*(this.tracked.x-i.x)/this.wrapper.offsetWidth*n,this.magnification.delta=(this.tracked.z-i.z)/this.wrapper.offsetWidth*n*2,this.offset.delta=(this.tracked.y-i.y)/this.wrapper.offsetHeight,this.rotate(this.rotation.current+this.rotation.delta),this.magnify(this.magnification.current-this.magnification.delta,this.offset.current+this.offset.delta),this.tracked.x=i.x,this.tracked.y=i.y,this.tracked.z=i.z);break;case"end":this.tracked=null,this.momentum()}},this.resize=function(){this.wrapperAspect=this.wrapper.offsetWidth/this.wrapper.offsetHeight;var t=this.magnification.current||1,e=this.offset.current||0,i=this.rotation.current||this.fov/2;this.magnify(t,e),this.rotate(i)}};var Photowall=function(t){return this.only=function(t){return new this.Main(t,this)},this.each=function(t){for(var e,i=[],n=0,o=t.elements.length;n<o;n+=1)(e=Object.create(t)).element=t.elements[n],i[n]=new this.Main(e,this);return i},t.elements?this.each(t):this.only(t)};"undefined"!=typeof define&&define([],function(){return Photowall}),"undefined"!=typeof module&&(module.exports=Photowall),Photowall.prototype.Main=function(t,e){this.config=t,this.context=e,this.element=t.element,this.init=function(){for(var t=this.element.getElementsByTagName("img"),e=0,i=t.length;e<i;e+=1)t[e].style.visibility="hidden",t[e].parentNode.style.backgroundImage="url('"+t[e].getAttribute("src")+"')";return this},this.init()};var Polyfills=function(){this.html5=function(){var t,e,i=["section","nav","article","aside","hgroup","header","footer","dialog","mark","dfn","time","progress","meter","ruby","rt","rp","ins","del","figure","figcaption","video","audio","source","canvas","datalist","keygen","output","details","datagrid","command","bb","menu","legend"];if(navigator.userAgent.match(/msie/gi))for(t=0,e=i.length;t<e;t+=1)document.createElement(i[t])},this.arrayIndexOf=function(){Array.prototype.indexOf||(Array.prototype.indexOf=function(t,e){for(var i=e||0,n=this.length;i<n;i+=1)if(this[i]===t)return i;return-1})},this.arrayIsArray=function(){Array.isArray||(Array.isArray=function(t){return"[object Array]"===Object.prototype.toString.call(t)})},this.arrayMap=function(){Array.prototype.map||(Array.prototype.map=function(t,e){var i,n,o;if(null==this)throw new TypeError(" this is null or not defined");var s=Object(this),a=s.length>>>0;if("function"!=typeof t)throw new TypeError(t+" is not a function");for(1<arguments.length&&(i=e),n=new Array(a),o=0;o<a;){var r,h;o in s&&(r=s[o],h=t.call(i,r,o,s),n[o]=h),o++}return n})},this.querySelectorAll=function(){document.querySelectorAll||(document.querySelectorAll=function(t){var e=document,i=e.documentElement.firstChild,n=e.createElement("STYLE");return i.appendChild(n),e.__qsaels=[],n.styleSheet.cssText=t+"{x:expression(document.__qsaels.push(this))}",window.scrollBy(0,0),e.__qsaels})},this.addEventListener=function(){var t,e,i,n,o,s,a;window.addEventListener||(t=Window.prototype,e=HTMLDocument.prototype,i=Element.prototype,o="removeEventListener",s="dispatchEvent",a=[],t[n="addEventListener"]=e[n]=i[n]=function(t,e){var i=this;a.unshift([i,t,e,function(t){t.currentTarget=i,t.preventDefault=function(){t.returnValue=!1},t.stopPropagation=function(){t.cancelBubble=!0},t.target=t.srcElement||i,e.call(i,t)}]),this.attachEvent("on"+t,a[0][3])},t[o]=e[o]=i[o]=function(t,e){for(var i,n=0;i=a[n];++n)if(i[0]==this&&i[1]==t&&i[2]==e)return this.detachEvent("on"+t,a.splice(n,1)[0][3])},t[s]=e[s]=i[s]=function(t){return this.fireEvent("on"+t.type,t)})},this.consoleLog=function(){var t=new RegExp("console-log","i");window.console&&!t.test(document.querySelectorAll("html")[0].className)||(window.console={},window.console.log=function(){var t,e,i="",n=document.getElementById("reportPanel");n||((n=document.createElement("DIV")).id="reportPanel",n.style.background="#fff none",n.style.border="solid 1px #000",n.style.color="#000",n.style.fontSize="12px",n.style.padding="10px",n.style.position=-1<navigator.userAgent.indexOf("MSIE 6")?"absolute":"fixed",n.style.right="10px",n.style.bottom="10px",n.style.width="180px",n.style.height="320px",n.style.overflow="auto",n.style.zIndex="100000",n.innerHTML="&nbsp;",document.body.appendChild(n));var o=n.innerHTML.length<1e3?n.innerHTML:n.innerHTML.substring(0,800);for(t=0,e=arguments.length;t<e;t+=1)i+=arguments[t]+"<br/>";i+="<hr/>",n.innerHTML=i+o})},this.objectCreate=function(){"function"!=typeof Object.create&&(Object.create=function(t){function e(){}return e.prototype=t,new e})},this.stringTrim=function(){String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^[\s\uFEFF]+|[\s\uFEFF]+$/g,"")}),String.prototype.ltrim||(String.prototype.ltrim=function(){return this.replace(/^\s+/,"")}),String.prototype.rtrim||(String.prototype.rtrim=function(){return this.replace(/\s+$/,"")}),String.prototype.fulltrim||(String.prototype.fulltrim=function(){return this.replace(/(?:(?:^|\n)\s+|\s+(?:$|\n))/g,"").replace(/\s+/g," ")})},this.localStorage=function(){window.localStorage||(/MSIE 8|MSIE 7|MSIE 6/i.test(navigator.userAgent)?(window.localStorage={getItem:function(t){return t&&this.hasOwnProperty(t)?unescape(document.cookie.replace(new RegExp("(?:^|.*;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=\\s*((?:[^;](?!;))*[^;]?).*"),"$1")):null},key:function(t){return unescape(document.cookie.replace(/\s*\=(?:.(?!;))*$/,"").split(/\s*\=(?:[^;](?!;))*[^;]?;\s*/)[t])},setItem:function(t,e){t&&(document.cookie=escape(t)+"="+escape(e)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/",this.length=document.cookie.match(/\=/g).length)},length:0,removeItem:function(t){t&&this.hasOwnProperty(t)&&(document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/",this.length--)},hasOwnProperty:function(t){return new RegExp("(?:^|;\\s*)"+escape(t).replace(/[\-\.\+\*]/g,"\\$&")+"\\s*\\=").test(document.cookie)}},window.localStorage.length=(document.cookie.match(/\=/g)||window.localStorage).length):Object.defineProperty(window,"localStorage",new function(){var a=[],r={};Object.defineProperty(r,"getItem",{value:function(t){return t?this[t]:null},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(r,"key",{value:function(t){return a[t]},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(r,"setItem",{value:function(t,e){t&&(document.cookie=escape(t)+"="+escape(e)+"; expires=Tue, 19 Jan 2038 03:14:07 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),Object.defineProperty(r,"length",{get:function(){return a.length},configurable:!1,enumerable:!1}),Object.defineProperty(r,"removeItem",{value:function(t){t&&(document.cookie=escape(t)+"=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/")},writable:!1,configurable:!1,enumerable:!1}),this.get=function(){var t;for(var e in r)-1===(t=a.indexOf(e))?r.setItem(e,r[e]):a.splice(t,1),delete r[e];for(;0<a.length;a.splice(0,1))r.removeItem(a[0]);for(var i,n,o=0,s=document.cookie.split(/\s*;\s*/);o<s.length;o++)1<(i=s[o].split(/\s*=\s*/)).length&&(r[n=unescape(i[0])]=unescape(i[1]),a.push(n));return r},this.configurable=!1,this.enumerable=!0}))},this.functionBind=function(){Function.prototype.bind||(Function.prototype.bind=function(t){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");function e(){}function i(){return o.apply(this instanceof e&&t?this:t,n.concat(Array.prototype.slice.call(arguments)))}var n=Array.prototype.slice.call(arguments,1),o=this;return e.prototype=this.prototype,i.prototype=new e,i})},this.html5(),this.arrayIndexOf(),this.arrayIsArray(),this.arrayMap(),this.querySelectorAll(),this.addEventListener(),this.consoleLog(),this.objectCreate(),this.stringTrim(),this.localStorage(),this.functionBind()};"undefined"!=typeof define&&define([],function(){return polyfills}),"undefined"!=typeof module&&(module.exports=polyfills);var requests={randomise:function(t){return t.replace("?","?time="+(new Date).getTime()+"&")},all:function(e,t){var i=this,n=e.urls[e.urls.length-1],o=t||[];this.send({url:n,post:e.post||null,contentType:e.contentType||"text/xml",timeout:e.timeout||4e3,onTimeout:e.onTimeout||function(t){return t},onProgress:function(t){e.onProgress({})},onFailure:e.onFailure||function(t){return t},onSuccess:function(t){o.push({url:n,response:t.response,responseText:t.responseText,responseXML:t.responseXML,status:t.status}),e.urls.length=e.urls.length-1,0<e.urls.length?i.all(e,o):e.onSuccess(o)}})},create:function(t){var e,i=this;return window.XDomainRequest&&t.xdomain?((e=new XDomainRequest).onload=function(){t.onSuccess(e,t)},e.onerror=function(){t.onFailure(e,t)},e.ontimeout=function(){t.onTimeout(e,t)},e.onprogress=function(){t.onProgress(e,t)}):window.XMLHttpRequest?((e=new XMLHttpRequest).timeout&&(e.timeout=t.timeout||0),e.ontimeout=function(){t.onTimeout(e,t)},e.onreadystatechange=function(){i.update(e,t)}):(e=new ActiveXObject("Microsoft.XMLHTTP")).onreadystatechange=function(){i.update(e,t)},e},send:function(e){e.onSuccess=e.onSuccess||function(){},e.onFailure=e.onFailure||function(){},e.onTimeout=e.onTimeout||function(){},e.onProgress=e.onProgress||function(){};var t=this.create(e);if(e.post)try{t.open("POST",e.url,!0),t.setRequestHeader("Content-type",e.contentType||"application/x-www-form-urlencoded"),t.send(e.post)}catch(t){e.onFailure({readyState:-1,status:-1,statusText:t})}else try{t.open("GET",this.randomise(e.url),!0),t.send()}catch(t){e.onFailure({readyState:-1,status:-1,statusText:t})}},update:function(t,e){if(4===t.readyState)switch(t.status){case 200:case 304:e.onSuccess(t,e);break;default:e.onFailure(t,e)}else e.onProgress(t,e)},deserialize:function(t){var e;return window.DOMParser?e=(new DOMParser).parseFromString(t,"text/xml"):((e=new ActiveXObject("Microsoft.XMLDOM")).async="false",e.loadXML(t)),e},decode:function(t){var e;return e={},"undefined"!=typeof JSON&&void 0!==JSON.parse?e=JSON.parse(t):"undefined"!=typeof jQuery&&(e=jQuery.parseJSON(t)),e}};"undefined"!=typeof define&&define([],function(){return requests}),"undefined"!=typeof module&&(module.exports=requests),toGeoJSON=function(){"use strict";var c,e=/\s*/g,o=/^\s*|\s*$/g,s=/\s+/;function l(t){if(!t||!t.length)return 0;for(var e=0,i=0;e<t.length;e++)i=(i<<5)-i+t.charCodeAt(e)|0;return i}function T(t,e){return t.getElementsByTagName(e)}function u(t,e){return t.getAttribute(e)}function n(t,e){return parseFloat(u(t,e))}function A(t,e){var i=T(t,e);return i.length?i[0]:null}function d(t){for(var e=0,i=[];e<t.length;e++)i[e]=parseFloat(t[e]);return i}function D(t){return t&&function(t){t.normalize&&t.normalize()}(t),t&&t.firstChild&&t.firstChild.nodeValue||""}function _(t){return d(t.replace(e,"").split(","))}function I(t){for(var e=t.replace(o,"").split(s),i=[],n=0;n<e.length;n++)i.push(_(e[n]));return i}function m(t){var e=[n(t,"lon"),n(t,"lat")],i=A(t,"ele");return i&&e.push(parseFloat(D(i))),e}return"undefined"!=typeof XMLSerializer?c=new XMLSerializer:"object"!=typeof exports||"object"!=typeof process||process.browser||(c=new(require("xmldom").XMLSerializer)),{kml:function(t,e){for(var i,n={type:"FeatureCollection",features:[]},M={},z=["Polygon","LineString","Point","Track"],o=T(t,"Placemark"),s=T(t,"Style"),a=0;a<s.length;a++)M["#"+u(s[a],"id")]=l((i=s[a],c.serializeToString(i))).toString(16);for(var r=0;r<o.length;r++)n.features=n.features.concat(h(o[r]));function S(t){var e,i;return"#"===(t=t||"").substr(0,1)&&(t=t.substr(1)),6!==t.length&&3!==t.length||(e=t),8===t.length&&(i=parseInt(t.substr(0,2),16)/255,e=t.substr(2)),[e,isNaN(i)?void 0:i]}function E(t){for(var e=T(t,"coord"),i=[],n=0;n<e.length;n++)i.push(d(D(e[n]).split(" ")));return i}function h(t){var e,i=function t(e){var i,n,o,s,a,r=[];if(A(e,"MultiGeometry"))return t(A(e,"MultiGeometry"));if(A(e,"MultiTrack"))return t(A(e,"MultiTrack"));for(o=0;o<z.length;o++)if(n=T(e,z[o]))for(s=0;s<n.length;s++)if(i=n[s],"Point"==z[o])r.push({type:"Point",coordinates:_(D(A(i,"coordinates")))});else if("LineString"==z[o])r.push({type:"LineString",coordinates:I(D(A(i,"coordinates")))});else if("Polygon"==z[o]){var h=T(i,"LinearRing"),c=[];for(a=0;a<h.length;a++)c.push(I(D(A(h[a],"coordinates"))));r.push({type:"Polygon",coordinates:c})}else"Track"==z[o]&&r.push({type:"LineString",coordinates:E(i)});return r}(t),n={},o=D(A(t,"name")),s=D(A(t,"styleUrl")),a=D(A(t,"description")),r=A(t,"TimeSpan"),h=A(t,"ExtendedData"),c=A(t,"LineStyle"),l=A(t,"PolyStyle");if(!i.length)return[];if(o&&(n.name=o),s&&M[s]&&(n.styleUrl=s,n.styleHash=M[s]),a&&(n.description=a),r){var u=D(A(r,"begin")),d=D(A(r,"end"));n.timespan={begin:u,end:d}}if(c){var m=S(D(A(c,"color"))),p=m[0],f=m[1],g=parseFloat(D(A(c,"width")));p&&(n.stroke=p),isNaN(f)||(n["stroke-opacity"]=f),isNaN(g)||(n["stroke-width"]=g)}if(l){var v=S(D(A(l,"color"))),y=v[0],b=v[1],w=D(A(l,"fill")),k=D(A(l,"outline"));y&&(n.fill=y),isNaN(b)||(n["fill-opacity"]=b),w&&(n["fill-opacity"]="1"===w?1:0),k&&(n["stroke-opacity"]="1"===k?1:0)}if(h){var x=T(h,"Data"),L=T(h,"SimpleData");for(e=0;e<x.length;e++)n[x[e].getAttribute("name")]=D(A(x[e],"value"));for(e=0;e<L.length;e++)n[L[e].getAttribute("name")]=D(L[e])}return[{type:"Feature",geometry:1===i.length?i[0]:{type:"GeometryCollection",geometries:i},properties:n}]}return n},gpx:function(t,e){var i,n,o=T(t,"trk"),s=T(t,"rte"),a=T(t,"wpt"),r={type:"FeatureCollection",features:[]};for(i=0;i<o.length;i++)r.features.push(c(o[i]));for(i=0;i<s.length;i++)r.features.push({type:"Feature",properties:u(n=s[i]),geometry:{type:"LineString",coordinates:h(n,"rtept")}});for(i=0;i<a.length;i++)r.features.push(l(a[i]));function h(t,e){for(var i=T(t,e),n=[],o=0;o<i.length;o++)n.push(m(i[o]));return n}function c(t){for(var e=T(t,"trkseg"),i=[],n=0;n<e.length;n++)i.push(h(e[n],"trkpt"));return{type:"Feature",properties:u(t),geometry:{type:1===i.length?"LineString":"MultiLineString",coordinates:1===i.length?i[0]:i}}}function l(t){var e=u(t);return e.sym=D(A(t,"sym")),{type:"Feature",properties:e,geometry:{type:"Point",coordinates:m(t)}}}function u(t){var e,i=["name","desc","author","copyright","link","time","keywords"],n={};for(e=0;e<i.length;e++)n[i[e]]=D(A(t,i[e]));return function(t){var e={};for(var i in t)t[i]&&(e[i]=t[i]);return e}(n)}return r}}}(),"undefined"!=typeof module&&(module.exports=toGeoJSON);